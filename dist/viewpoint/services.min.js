angular.module("vpApi.services",[]).service("$mediacache",["$vpApi","$formstack","$http",function(e,o,r){var n=this;n.isCached=!1,this.run=function(){var o=n.getFilenames();_.each(o,function(o){r({method:"GET",withCredentials:!0,url:o}).success(function(r){var n=e.db.getCollection("media"),t=n.find({fname:o});t.length>0?(t.cupdate=e.getTimestamp(),n.update(t)):(t={fname:o,data:r,cupdate:e.getTimestamp()},n.insert(t)),e.db.save()}).error(function(){console.log("Could not load media file ")})})},this.getFilenames=function(){var o=e.getFormstack(),r=[];return _.each(o.forms,function(e){_.each(e.blocks,function(e){_.each(e.questions,function(e){e.options.geojsonChoices&&e.options.geojsonChoices.url&&r.push(e.options.geojsonChoices.url)})})}),r=_.uniq(r),console.log("[getFilenames] Files to cache: "),console.log(r),r}}]).service("$tilecache",["$vpApi","$formstack","$timeout",function(e,o,r){var n=this;this.regions=[],this.cacheTimer={start:null,stop:null,elasped:null},this.isCached=function(){var e=localStorage.getItem("tilesCached"),o="true"===e?!0:!1;return o},this.getMaxCacheZoom=function(){var o,r=e.getFormstack(),n=_.find(r.forms,function(e){return"map-form"===e.type});return o=n?n.options.maxCacheZoom:null},this.getRegions=function(){var o=[],r=e.getFormstack();return _.each(r.forms,function(e){"map-form"===e.type&&e.options.regions&&(o=_.uniq(o.concat(e.options.regions)))}),n.regions=o,o},this.getTileSources=function(){var o=e.getFormstack(),r=_.find(o.forms,function(e){return"map-form"===e.type&&e.options.tileSources});return n.tileSources=r.options.tileSources,n.tileSources},this.loadRegions=function(e,o,r){if(0===n.regions.length)return n.getRegions(),void(0===n.regions.length);var t=n.getMaxCacheZoom(),s=e.calculateNbTiles(t,n.regions);console.log("Will be saving: "+s+" tiles"),e.saveRegions(n.regions,t,function(){console.log("[saveRegions] onStarted")},function(){console.log("[saveRegions] onSuccess"),n.cacheTimer.stop=new Date,n.cacheTimer.elasped=n.cacheTimer.stop-n.cacheTimer.start,console.log("Cache timer elapsed time (min): "+n.cacheTimer.elasped/1e3/60),localStorage.setItem("tilesCached","true"),o()},function(e){console.log("onError"),console.log(e),r()})},this.run=function(e,o){n.offlineLayers=[],n.cacheTimer.start=new Date;var t=n.getTileSources();onError=function(e,r,n){console.log("[$tilecache.run.onError()] "),localStorage.setItem("tilesCached","false"),console.log(e),console.log(r),console.log(n),o()};var s=L.map("cache-map").setView([-2.9,-79],13);_.each(t,function(t){var c={map:s,maxZoom:n.getMaxCacheZoom(),attribution:t.attrib,subdomains:t.subdomain,dbOnly:!0,onReady:function(){console.log("onReady for what?")},onError:function(){console.log("onError for what?")},storeName:t.storeName,dbOption:"IndexedDB"},i=new OfflineLayer(t.url,c);n.offlineLayers.push(i),r(function(){n.loadRegions(i,e,o)},1e3)})},this.clearTiles=function(){console.log("clearing tiles..."),n.offlineLayer.clearTiles(function(){console.log("[clearTiles] success")},function(){console.log("[clearTiles] fail")})},this.clearTilesDb=function(e){tilesSources=n.getTileSources(),osTableName=tilesSources[0].storeName,dbName="IDBWrapper-"+osTableName;var o=window.indexedDB.open(dbName,1);o.onerror=function(e){console.log("[openTilesDb] Database error: "+e.target.errorCode)},o.onsuccess=function(){window.db=o.result,console.log("[openTilesDb] Opened "+dbName+" with dataStores"),console.log(window.db.objectStoreNames);var r=window.db.transaction(osTableName,"readwrite").objectStore(osTableName);r.clear().onsuccess=function(o){localStorage.removeItem("tilesCached"),console.log("Finished clearing records"),e(o)}}}}]),angular.module("survey.services",[]).factory("$formUtils",["$vpApi","$location","$formstack","$formResp",function($vpApi,$location,$formstack,$formResp){var obj=this;return setState=function(e,o,r){if(e.current={fsResp:null,form:null,formIndex:null,formResp:null,block:null,blockIndex:null,blockResp:null,qIndex:null,hash:null},e.formstack=$vpApi.getFormstack(),e.fsResps=$vpApi.db.getCollection("fsResp"),e.formResps=$vpApi.db.getCollection("formResp"),e.blockResps=$vpApi.db.getCollection("blockResp"),e.answers=$vpApi.db.getCollection("answer"),e.medias=$vpApi.db.getCollection("media"),"new"===r.fsRespId?(e.current.form=angular.copy(e.formstack.forms[0]),e.current.formIndex=0,e.current.block=angular.copy(e.formstack.forms[0].blocks[0]),e.current.blockIndex=0):(e.current.fsResp=e.fsResps.get(parseInt(r.fsRespId,10)),e.current.fsResp||console.error("Could not find Formstack Response: "+r.formRespId)),"app.map-form-foreach"===o.current.name||"app.map-form"===o.current.name){if(e.repeatCount=0,0===$location.hash().length&&$location.hash("intro"),e.current.hash=$location.hash(),r.formRespId="new",e.selectedFeatures={"type:":"FeatureCollection",features:[]},e.current.form=_.find(e.formstack.forms,function(e){return e.id===parseInt(r.formId,10)}),e.current.block=e.current.form.blocks[0],r.qIndex=r.qIndex||"intro",e.current.formRepeatItem,e.current.formResp&&e.current.formResp.formRepeatItem&&(e.current.formRepeatItem=e.current.formResp.formRepeatItem),e.current.formIndex=_.indexOf(e.formstack.forms,e.current.form),e.current.blockIndex=_.indexOf(e.current.form.blocks,e.current.block),e.current.form.options.forEach&&e.current.form.options.forEach.length>0);else if(e.current.form.options.forEachAnswer&&e.current.form.options.forEachAnswer.length>0){var n=_getAnswer(e,e.current.form.options.forEachAnswer,e.current.fsRespId);e.forEach=[],_.each(n.value,function(o){e.forEach.push({verbose:o,value:o})})}else e.forEach=[{verbose:"",value:"default"}];e.mapQuestion=e.current.block.questions[0],_.each(e.current.block.questions,function(e){e.form={show:!1}})}else if("app.form-foreach"===o.current.name)e.current.form=_.find(e.formstack.forms,function(e){return e.id===parseInt(r.formId,10)}),e.current.formIndex=_.indexOf(e.formstack.forms,e.current.form),e.current.page=r.page,e.current.form.forEach=null,e.current.form.repeatItem=null;else{if("new"===r.formRespId.split("-")[0]){var t=r.formRespId.split("-");if(2===t.length){var s=parseInt(t[1],10);e.current.form=_.find(e.formstack.forms,function(e){return e.id===s}),e.current.formIndex=_.indexOf(e.formstack.forms,e.current.form)}else{var s=null;e.current.form=e.formstack.forms[0],e.current.formIndex=0}}else r.formRespId.length<1&&console.error("No formRespId found in the URL"),e.current.formResp=e.formResps.get(parseInt(r.formRespId,10)),e.current.formIndex=e.current.formResp.formIndex,e.current.form=e.formstack.forms[e.current.formIndex];if("new"===r.blockRespId.split("-")[0]){var t=r.blockRespId.split("-");if(2===t.length){var c=parseInt(t[1],10);e.current.block=_.find(e.current.form.blocks,function(e){return e.id===c}),e.current.blockIndex=_.indexOf(e.current.form.blocks,e.current.block)}else e.current.block=e.current.form.blocks[0],e.current.blockIndex=0}else r.blockRespId.length<1&&console.error("No blockRespId found in the URL"),e.current.blockResp=e.blockResps.get(parseInt(r.blockRespId,10)),e.current.blockIndex=e.current.blockResp.blockIndex,e.current.block=e.current.form.blocks[e.current.blockIndex]}if(e.current.form.options.forEach&&e.current.form.options.forEach.length>0);else if(e.current.form.options.forEachAnswer&&e.current.form.options.forEachAnswer.length>0){var i,n=_getAnswer(e,e.current.form.options.forEachAnswer,e.current.fsRespId);e.current.form.forEach=[],_.each(n.value,function(o){i=$formstack.getChoice(e.current.form.options.forEachAnswer,o),e.current.form.forEach.push(i)})}if(e.current.form.forEach&&loadFormForEachItems(e),e.current.block)if(e.current.block.options.forEach&&e.current.block.options.forEach.length>0);else if(e.current.block.options.forEachAnswer&&e.current.block.options.forEachAnswer.length>0){var n=_getAnswer(e,e.current.block.options.forEachAnswer,e.current.fsRespId);e.current.block.forEach=[],_.each(n.value,function(o){e.current.block.forEach.push({verbose:o,value:o})})}e.current.formResp&&"undefined"!=typeof e.current.formResp.formForEachItem&&(i=$formstack.getChoice(e.current.formResp.formForEachQuestionSlug,e.current.formResp.formForEachItem),e.current.form.forEachItem=i)},changeState=function(e,o,r){{var n,t,s,c,i,l="app.",a=null;e.current.form.blocks}if(getAnswer=function(o){fsRespId=e.current.fsResp.$loki,answers=$vpApi.db.getCollection("answer");var r=$vpApi.db.getCollection("answer").chain().find({questionSlug:o}).find({fsRespId:fsRespId}).data();return r.length>1?(console.log("found more than one answer, returns the first one."),console.table(r),r=r[0]):1===r.length?r=r[0]:(r=null,console.error("[]getAnswer] No answer found")),console.log("Found answer: "+r),r},"forward"===r||"repeat-block"===r||"repeat-form"===r){if("forward"===r?t="end"===e.current.page||"intro"===e.current.page?null:this.getEligibleBlock(r,e.current.form,e.current.blockIndex):("repeat-block"===r||"repeat-form"===r)&&(t=e.current.block),t){console.log("[LinearBlockCtrl.saveBlock()] found next block, setting state");var f,u;if("forward"===r){formRespId=e.current.formResp.$loki;var p=e.blockResps.chain().find({blockId:t.id}).find({formRespId:e.current.formResp.$loki}).data();f=p.length>0?p.slice(-1)[0].$loki:"new-"+t.id}else if("repeat-form"===r){if("map-form"===e.current.form.type)return void $location.hash("intro");e.current.formRepeatItem=null,formRespId="new-"+e.current.form.id,f="new-"+t.id}else if("repeat-block"===r){if("map-form"===e.current.form.type){var f="new-"+e.current.block.id;return void $location.hash([formRespId,f,0].join("/"))}formRespId=e.current.formResp.$loki,f="new-"+t.id,a="0"}return l+=e.current.form.type?e.current.form.type:"form",e.current.form.forEach&&_.indexOf(e.current.form.blocks,t)===e.current.form.blocks.length-1&&(l+="-foreach",u="end"),n={fsSlug:e.formstack.slug,fsRespId:e.current.fsResp.$loki,formRespId:formRespId,formId:e.current.form.id,blockRespId:f,hash:a,page:u,qIndex:a},void o.go(l,n)}return console.log("[LinearBlockCtrl.saveBlock()] No more blocks in this form, so grabbing the first block of the next form"),s=this.getEligibleForm(r,e.current.formIndex),s?(t=getEligibleBlock("forward",s,-1),l+=s.type?s.type:"form",(s.options.forEach||s.options.forEachAnswer)&&(l+="-foreach",a="intro"),n={fsSlug:e.formstack.slug,fsRespId:e.current.fsResp.$loki,formId:s.id,formRespId:"new-"+s.id,blockRespId:"new-"+t.id,hash:a,page:a,qIndex:"intro"},void o.go(l,n)):(console.log("[LinearBlockCtrl.saveBlock()] No more forms. You are done."),e.current.fsResp.status="complete",e.current.fsResp.cupdate=$vpApi.getTimestamp(),$vpApi.db.save(),console.log("[LinearBlockCtrl.saveBlock()] No more forms. You are done."),void o.go("app.complete"))}if("back"===r)if(m=this.getEligibleBlock(r,e.current.form,e.current.blockIndex)){console.log("[LinearBlockCtrl.saveBlock()] found next block");var d=e.blockResps.chain().find({blockId:m.id}).find({formRespId:e.current.formResp.$loki}).data();i=d.length>0?d.slice(-1)[0]:{id:"new-"+m.id},l+=e.current.form.type?e.current.form.type:"form",n={fsSlug:e.formstack.slug,fsRespId:e.current.fsResp.$loki,formRespId:e.current.formResp.$loki,blockRespId:i.$loki,hash:a}}else{if(console.log("[LinearBlockCtrl.saveBlock()] This is the first block in the form"),prevForm=this.getEligibleForm(r,e.current.formIndex),!prevForm)return console.log("[LinearBlockCtrl.saveBlock()] No more forms. You are done."),void o.go("app.home");console.log("[LinearBlockCtrl.saveBlock()] Found prev form");var c=e.formResps.chain().find({fsRespId:e.current.fsResp.$loki}).find({formId:prevForm.id}).data();c=c.length>1?c.slice(-1)[0]:1===c.length?c[0]:{id:"new-"+prevForm.id};var m=this.getEligibleBlock(r,prevForm,prevForm.blocks.length),i=e.blockResps.chain().find({blockId:m.id}).find({formRespId:c.$loki}).data();i=i.length>1?i.slice(-1)[0]:1===i.length?i[0]:{id:"new-"+m.id},l+=prevForm.type?prevForm.type:"form",(prevForm.options.forEach||prevForm.options.forEachAnswer)&&(l+="-foreach",u="intro"),n={fsSlug:e.formstack.slug,fsRespId:e.current.fsResp.$loki,formRespId:c.$loki,formId:prevForm.id,blockRespId:i.$loki,hash:u,page:u}}e.newStateParams=n,o.go(l,n)},_getAnswer=function(e,o,r){r=r||e.current.fsResp.$loki,answers=$vpApi.db.getCollection("answer");var n=$vpApi.db.getCollection("answer").chain().find({questionSlug:o}).find({fsRespId:r}).data();return n.length>1?(console.log("found more than one answer, returns the first one."),console.table(n),n=n[0]):n=1===n.length?n[0]:null,console.log("Found answer: "+n),n},getEligibleBlock=function(direction,form,currentBlockIndex){function findEligibleBlock(direction){return console.log("[findEligibleNextBlock] looking for blockIndex "+currentBlockIndex),block="forward"===direction?blocks[currentBlockIndex+1]:blocks[currentBlockIndex-1],block?"undefined"!=typeof block.options.skipWhen&&(rs=eval(block.options.skipWhen),rs?(console.log("[_getNextBlock()] I need to skip this block and get the next one"),"forward"===direction?currentBlockIndex++:currentBlockIndex--,findEligibleBlock(direction)):console.log("[_getNextBlock()] I can use this block.")):console.log("[_getNextBlock] there are no more blocks on this form"),block}var out,block,rs,blocks=form.blocks;return block=findEligibleBlock(direction)},loadFormForEachItems=function(e){var o;_.each(e.current.form.forEach,function(o){o.formResp=e.formResps.chain().find({fsRespId:e.current.fsResp.$loki}).find({formId:e.current.form.id}).find({formRepeatItem:o.value}).data(),0===o.formResp.length?(console.log("Create a formResp for "+o),o.formResp=e.formResps.insert({fsSlug:e.formstack.slug,fsRespId:e.current.fsResp.$loki,formId:e.current.form.id,formIndex:e.current.formIndex,formRepeatItem:o.value,formForEachItem:o.value,formForEachQuestionSlug:e.current.form.options.forEachAnswer,cupdate:$vpApi.getTimestamp()}),$vpApi.db.save()):o.formResp=o.formResp[0],o.blockResps=e.blockResps.chain().find({fsRespId:e.current.fsResp.$loki}).find({formRespId:o.formResp.$loki}).simplesort("created").data(),o.blockResps.length>0?(o.formRespId=o.blockResps[0].formRespId,o.blockRespId=o.blockResps[0].$loki):(o.formRespId="new-"+e.current.form.id,o.blockRespId="new-"+e.current.form.blocks[0].id),o.form="form"});var r=e.formResps.chain().find({formId:e.current.form.id}).find({fsRespId:e.current.fsResp.$loki});_.each(e.current.form.forEach,function(e){r.find({formForEachItem:{$ne:e.value}})}),o=r.data(),console.log("Stale Form Resps"),console.table(o),_.each(o,function(e){$formResp.delete(e.$loki)})},getEligibleForm=function(direction,currentFormIndex){function findEligibleForm(direction){return console.log("[findNextEligibleForm] looking for formIndex "+currentFormIndex),form="forward"===direction?forms[currentFormIndex+1]:forms[currentFormIndex-1],form?"undefined"!=typeof form.options.skipWhen&&(rs=eval(form.options.skipWhen),rs?(console.log("[_findNextEligibleForm()] I need to skip this form and get the next one"),"forward"===direction?currentFormIndex++:currentFormIndex--,findEligibleForm(direction)):console.log("[_findNextEligibleForm()] I can use this form.")):console.log("[_getNextBlock] there are no more forms on this form"),form}var forms=$vpApi.getFormstack().forms;return form=findEligibleForm(direction)},loadAnswers=function(e,o,r,n){console.log("[$formUtils.loadAnswers()]");var t=!1;r+="",n+="",("new"===o||"new"===r.split("-")[0]||"new"===n.split("-")[0])&&(t=!0),e.previousAnswers=t?[]:e.answers.chain().find({fsRespId:parseInt(o,10)}).find({formRespId:parseInt(r,10)}).find({blockRespId:parseInt(n,10)}).data(),_.each(e.current.block.questions,function(o){var r=_.find(e.previousAnswers,function(e){return e.questionId===o.id});console.log("[loadAnswers] Question: "+o.slug),r?(o.value=r.value,o.previousValue=r.value,o.answerCid=r.$loki):"undefined"!=typeof o.options["default"]?(o.value=o.options["default"],o.previousValue=o.options["default"],o.answerCid=null):(o.value="",o.previousValue="",o.answerCid=null)})},parseHash=function(e){var o;if("intro"===e||"end"===e)return e;var r=e.split("/");return 3===r.length?(formRespId=r[0],blockRespId=r[1],qIndex=parseInt(r[2]),o=[formRespId,blockRespId,qIndex]):o=e,o},{setState:setState,changeState:changeState,getAnswer:_getAnswer,getEligibleForm:getEligibleForm,getEligibleBlock:getEligibleBlock,loadAnswers:loadAnswers,parseHash:parseHash}}]),angular.module("vpApi.services",[]).service("$vpApi",["$rootScope","$http","config",function(e,o,r){var n=this,t=r.apiBaseUri;this.username="",this.user={},this.users,this.dbLoaded=!1,this.dbinit=function(e){return n.db=data.db,n.user=data.user,n.users=data.db.getCollection("user"),void(n.dbLoaded=!0)},this.getApp=function(e){var o=$vpApi.db.getCollection("app"),r=o.find({slug:e})[0];return r.length>0?r:void console.log("eror getting app.")},this.getFormstack=function(e){console.log(e);var o=null,r=n.db.getCollection("formstack");return o=void 0==e||null==e?r.find()[0]:r.find({slug:e})[0],o||console.error("[$vpApi.getFormstack()] Could not find formstack"),o},this.getTimestamp=function(){return(new Date).toISOString()},this.serialize=function(e){var o=[];for(var r in e)e.hasOwnProperty(r)&&o.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return o.join("&")},this.authenticate=function(r,s,c){var i=t+"authenticate/",l={};o.post(i,r,l).success(function(o){var t=n.users.find({username:r.username});0===t.length?user=n.users.insert({username:r.username,token:o.token}):(user=t[0],user.token=o.token,user.username=r.username,n.users.update(user)),n.user=user,n.db.save(),localStorage.setItem("user",JSON.stringify(n.user)),e.$broadcast("authenticated",{onSuccess:s})}).error(function(e,o){c(e,o)})},this.fetch=function(e,r,n,s){var c=t+e+"/",i=this.serialize(r);c+="?"+i;var l={headers:{Authorization:"Token "+this.user.token}};o.get(c,l).success(function(e,o){n(e,o)}).error(function(e,o){s(e,o)})},this.post=function(e,r,n,s){{var c=t+e+"/";({headers:{Authorization:"Token "+this.user.token}})}o({url:c,method:"POST",data:r,headers:{Authorization:"Token "+this.user.token}}).success(function(e,o){n(e,o)}).error(function(e,o){s(e,o)})},this.showCollection=function(e){console.log("SHOW TABLE: "+e),console.table(data.db.getCollection(e).data)},this.dbinit()}]).service("$user",["$rootScope","$vpApi","$app","$formstack","$profile",function(e,o,r,n,t){e.$on("authenticated",function(n,s){t.fetch(function(){o.db.save(),allowedApps=o.user.profile.allowed_apps,allowedApps.length>0?appSlug=allowedApps[0]:console.error("There are no allowed Apps for this user."),r.fetchBySlug(appSlug,function(r){formstacks=r.formstacks,oldStacks=o.db.getCollection("formstack").find(),_.each(oldStacks,function(e){o.db.getCollection("formstack").remove(e)}),_.each(formstacks,function(e){e.appId=r.id,e.appSlug=r.slug,o.db.getCollection("formstack").insert(e)}),o.db.save(),e.$broadcast("apploaded"),s.onSuccess()},function(e){console.log("[$user] failed to fetch formstack"),console.log(e)})},function(){console.log("Error fetching profile.")})})}]).service("$profile",["$http","$vpApi","config",function(e,o,r){var n=r.apiBaseUri;this.fetch=function(r,t){var s=n+"account/info/?user__username=",c=o.user.token,i={headers:{Authorization:"Token "+c}};e.get(s+o.user.username,i).success(function(e){o.user.profile=e[0],o.users.update(o.user),r()}).error(function(){t()})}}]).service("$app",["$vpApi",function(e){var o=this;this.resource_name="pforms/get/app",this._fetchSuccess=function(r){o.objects=r;var n=e.db.getCollection("app"),t=n.find({slug:r[0].slug});t.length>0&&n.remove(t),n.insert(r[0])},this._fetchFail=function(e,r){console.log("Failed to fetch "+o.resource_name+". Returned Status: "+r),console.log(e)},this.fetchBySlug=function(r,n,t){HAS_CONNECTION&&e.fetch(this.resource_name,{slug:r},function(t,s){o.objects=t;var c=e.db.getCollection("app"),i=c.find({slug:r});i.length>0&&c.remove(i),c.insert(t[0]),n(t[0],s)},function(e,r){console.log("Failed to fetch "+o.resource_name+". Returned Status: "+r),console.log(e),t(e,r)})},this.updateBySlug=function(r,n,t){var s={slug:r};e.fetch(this.resource_name,s,function(e,r){o._fetchSuccess(e,r),n(e[0])},function(e,r){o._fetchFail(e,r),t(e,r)})}}]).service("$formstack",["$vpApi",function(e){var o=this;this.resource_name="pforms/formstack",this.formRepeatItem,this._fetchSuccess=function(r){o.objects=r;var n=e.db.getCollection("formstack"),t=n.find({slug:r[0].slug});t.length>0&&n.remove(t),n.insert(r[0])},this._fetchFail=function(e,r){console.log("Failed to fetch "+o.resource_name+". Returned Status: "+r),console.log(e)},this.fetchBySlug=function(r,n,t){HAS_CONNECTION&&e.fetch(this.resource_name,{slug:r},function(t,s){o.objects=t;var c=e.db.getCollection("formstack"),i=c.find({slug:r});i.length>0&&c.remove(i),c.insert(t[0]),n(t[0],s)},function(e,r){console.log("Failed to fetch "+o.resource_name+". Returned Status: "+r),console.log(e),t(e,r)})},this.updateBySlug=function(r,n,t){var s={slug:r};e.fetch(this.resource_name,s,function(e,r){o._fetchSuccess(e,r),n(e[0])},function(e,r){o._fetchFail(e,r),t(e,r)})},this.getQuestionBySlug=function(o){var r,n=e.db.getCollection("formstack").data[0];return _.find(n.forms,function(e){return blockRes=_.find(e.blocks,function(e){return qRes=_.find(e.questions,function(e){return e.slug===o?(r=e,!0):void 0})})}),r},this.getChoice=function(e,r){var n,t=o.getQuestionBySlug(e);return n=_.find(t.choices,function(e){return e.value===r}),n||(n={verbose:"User Enter: "+r,value:r}),n}}]).service("$fsResp",["$vpApi","$rootScope",function(e,o){var r=this;this.resource_name="pforms/formstack-response",o.$on("db_loaded",function(){this.objects=e.db.getCollection("fsResp")}),this.delete=function(o){var n=r.objects.get(o);r.objects.remove(n);var t=e.db.getCollection("formResp").find({fsRespId:o}),s=e.db.getCollection("blockResp").find({fsRespId:o}),c=e.db.getCollection("answer").find({fsRespId:o});_.each(t,function(o){e.db.getCollection("formResp").remove(o)}),_.each(s,function(o){e.db.getCollection("blockResp").remove(o)}),_.each(c,function(o){e.db.getCollection("answer").remove(o)}),e.db.save()}}]).service("$formResp",["$vpApi",function(e){this.resource_name="pforms/form-response",this.delete=function(o){var r=e.db.getCollection("formResp").get(o);if(!r)return void console.warn("Form Response does not exist: "+o);var n=e.db.getCollection("blockResp").find({formRespId:o}),t=e.db.getCollection("answer").find({formRespId:o});e.db.getCollection("formResp").remove(r),_.each(n,function(o){e.db.getCollection("blockResp").remove(o)}),_.each(t,function(o){e.db.getCollection("answer").remove(o)}),e.db.save()}}]).service("$blockResponse",["$formstack","$block","$rootScope","$answers","$formResponse",function(e,o,r){this.resource_name="pforms/block-response",r.$on("answer-created",function(){})}]).service("$answers",["$form","$rootScope","$filter","$vpApi","config",function(){this.resource_name="pforms/answer"}]),angular.module("vpApi.services").service("$sync",["$rootScope","$http","config","$vpApi",function(e,o,r,n){var t=this;this.collections=["fsResp","formResp","blockResp","answer"],this.lastUpdate=localStorage.getItem("lastUpdate"),this.lastUpdate&&(this.lastUpdate=new Date(this.lastUpdate)),this.run=function(e){var o,r=0;return o=t.getChanges(),0===o.length?void e([{status:"",data:"No changes found"}]):(errors=[],OnSucess=function(){console.log("[$sync.run.OnSucess]"),r===o.length-1?e(errors):(r++,t.syncResponse(o[r],OnSucess,OnError))},OnError=function(n,s){console.log("[$sync.run.OnError]"),r===o.length-1?e(errors):(r++,errors.push({status:s,data:n}),t.syncResponse(o[r],OnSucess,OnError))},void this.syncResponse(o[r],OnSucess,OnError))},this.syncResponse=function(e,o,r){var t;"I"===e.operation&&(t="POST"),"U"===e.operation&&(t="PUT"),"D"===e.operation&&(t="DELETE"),"fsResp"===e.name||"formResp"===e.name||"blockResp"===e.name?resource="pforms/response":"answer"===e.name?resource="pforms/answer":console.error("[$sync.syncResponse()] Invalid resource name"+e.name),e.obj.formstack=e.obj.fsId,e.obj.reporter=n.user.profile.user,e.obj.org=n.user.profile.orgs[0].id,delete e.obj.meta,n.post(resource,e.obj,o,r)},this.run2=function(e){var o,r,n,s;s=t.getChanges(),errors=[],r=_.find(s,function(e){return"fsResp"===e.name}),n=_.find(s,function(e){return"answers"===e.name}),fsOnSucess=function(){this.syncResponse()},fsOnError=function(){console.log("[fsOnError]")},this.syncResponse(r.changes,fsOnSucess,fsOnError),e(o)},this.syncResponse2=function(e,o,r){var t="pforms/response",s=0;_.each(e,function(e){"I"===e.operation&&(sucess=function(e,r){o(e,r),s++},fail=function(e,o){console.error(o),r(e,o),s++},t="pforms/response",e.obj.formstack=e.obj.fsId,e.obj.reporter=n.user.profile.user,e.obj.org=n.user.profile.orgs[0].id,delete e.obj.meta,n.post(t,e.obj,sucess,fail))})},this.getChanges=function(){var e;return e=n.db.serializeChanges(t.collections),JSON.parse(e)}}]);