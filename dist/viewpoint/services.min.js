angular.module("cache.services",[]).service("$mediacache",["$vpApi","$formstack","$http",function(e,o,t){var r=this;r.isCached=!1,this.run=function(){var o=r.getFilenames();_.each(o,function(o){t({method:"GET",withCredentials:!0,url:o}).success(function(t){var r=e.db.getCollection("media"),s=r.find({fname:o});s.length>0?(s.cupdate=e.getTimestamp(),r.update(s)):(s={fname:o,data:t,cupdate:e.getTimestamp()},r.insert(s)),e.db.save()}).error(function(){console.log("Could not load media file ")})})},this.getFilenames=function(){var o=e.getFormstack(),t=[];return _.each(o.forms,function(e){_.each(e.blocks,function(e){_.each(e.questions,function(e){e.options.geojsonChoices&&e.options.geojsonChoices.url&&t.push(e.options.geojsonChoices.url)})})}),t=_.uniq(t),console.log("[getFilenames] Files to cache: "),console.log(t),t}}]).service("$tilecache",["$vpApi","$formstack","$timeout",function(e,o,t){var r=this;this.regions=[],this.cacheTimer={start:null,stop:null,elasped:null},this.isCached=function(e){var o=parseInt(localStorage.getItem("tilesCount"));return o===e},this.getMaxCacheZoom=function(){var o,t=e.getFormstack(),r=_.find(t.forms,function(e){return"map-form"===e.type});return o=r?r.options.maxCacheZoom:null},this.getRegions=function(e){var o=[];return _.each(e.forms,function(e){"map-form"===e.type&&e.options.regions&&(o=_.uniq(o.concat(e.options.regions)))}),r.regions=o,o},this.getTileSources=function(e){r.tileSources=[];var o=_.find(e.forms,function(e){return"map-form"===e.type&&e.options.tileSources});return o&&(r.tileSources=o.options.tileSources),r.tileSources},this.loadRegions=function(e,o,t){if(0===r.regions.length)return r.getRegions(),void(0===r.regions.length);var s=r.getMaxCacheZoom(),n=e.calculateNbTiles(s,r.regions);console.log("Will be saving: "+n+" tiles"),e.saveRegions(r.regions,s,function(){console.log("[saveRegions] onStarted")},function(){console.log("[saveRegions] onSuccess"),r.cacheTimer.stop=new Date,r.cacheTimer.elasped=r.cacheTimer.stop-r.cacheTimer.start,console.log("Cache timer elapsed time (min): "+r.cacheTimer.elasped/1e3/60);var e=parseInt(localStorage.getItem("tilesCount"))||0;localStorage.setItem("tilesCount",e+1),o()},function(e){console.log("onError"),console.log(e),t()})},this.run=function(o,s){r.offlineLayers=[],r.cacheTimer.start=new Date;var n=e.getApp();_.each(n.formstacks,function(e){tileSources=r.getTileSources(e)}),onError=function(e,o,t){console.log("[$tilecache.run.onError()] "),localStorage.setItem("tilesCount",0),console.log(e),console.log(o),console.log(t),s()};var c=L.map("cache-map").setView([-2.9,-79],13);_.each(tileSources,function(e){var n={map:c,maxZoom:r.getMaxCacheZoom(),attribution:e.attrib,subdomains:e.subdomain,dbOnly:!0,onReady:function(){console.log("onReady for what?")},onError:function(){console.log("onError for what?")},storeName:e.storeName,dbOption:"IndexedDB"},i=new OfflineLayer(e.url,n);r.offlineLayers.push(i),t(function(){r.loadRegions(i,o,s)},1e3)})},this.clearTiles=function(){console.log("clearing tiles..."),r.offlineLayer.clearTiles(function(){console.log("[clearTiles] success")},function(){console.log("[clearTiles] fail")})},this.clearTilesDb=function(o){var t=e.getApp(),s=[];_.each(t.formstacks,function(e){s=r.getTileSources(e)}),osTableNames=[],_.each(s,function(e,o){osTableNames.push(e.storeName),dbName="IDBWrapper-"+osTableNames[o];var t=window.indexedDB.open(dbName,1);t.onerror=function(e){console.log("[openTilesDb] Database error: "+e.target.errorCode)},t.onsuccess=function(){window.db=t.result,console.log("[openTilesDb] Opened "+window.db.name+" with dataStores"),console.log(window.db.objectStoreNames);var e=window.db.name.split("-")[1],o=window.db.transaction(e,"readwrite").objectStore(e);o.clear().onsuccess=function(){localStorage.removeItem("tilesCount"),console.log("Finished clearing "+e)}}}),o(event)}}]),angular.module("survey.services",[]).factory("$formUtils",["$vpApi","$location","$formstack","$formResp",function($vpApi,$location,$formstack,$formResp){var obj=this;return setState=function(e,o,t){e.current={fsResp:null,form:null,formIndex:null,formResp:null,block:null,blockIndex:null,blockResp:null,qIndex:null,hash:null};var r=null;if(t&&t.fsSlug&&(r=t.fsSlug),e.formstack=$vpApi.getFormstack(r),e.fsResps=$vpApi.db.getCollection("fsResp"),e.formResps=$vpApi.db.getCollection("formResp"),e.blockResps=$vpApi.db.getCollection("blockResp"),e.answers=$vpApi.db.getCollection("answer"),e.medias=$vpApi.db.getCollection("media"),"new"===t.fsRespId?(e.current.form=angular.copy(e.formstack.forms[0]),e.current.formIndex=0,e.current.block=angular.copy(e.formstack.forms[0].blocks[0]),e.current.blockIndex=0):(e.current.fsResp=e.fsResps.get(parseInt(t.fsRespId,10)),e.current.fsResp||console.error("Could not find Formstack Response: "+t.formRespId)),"app.map-form-foreach"===o.current.name||"app.map-form"===o.current.name)if(e.repeatCount=0,0===$location.hash().length&&$location.hash("intro"),e.current.hash=$location.hash(),t.formRespId="new",e.selectedFeatures={"type:":"FeatureCollection",features:[]},e.current.form=_.find(e.formstack.forms,function(e){return e.id===parseInt(t.formId,10)}),e.current.block=e.current.form.blocks[0],e.mapQuestion=e.current.block.questions[0],e.mapQuestion.value="",_.each(e.current.block.questions,function(e){e.form={show:!1}}),t.qIndex=t.qIndex||"intro",e.current.formRepeatItem,e.current.formResp&&e.current.formResp.formRepeatItem&&(e.current.formRepeatItem=e.current.formResp.formRepeatItem),e.current.formIndex=_.indexOf(e.formstack.forms,e.current.form),e.current.blockIndex=_.indexOf(e.current.form.blocks,e.current.block),e.current.form.options.forEach&&e.current.form.options.forEach.length>0);else if(e.current.form.options.forEachAnswer&&e.current.form.options.forEachAnswer.length>0){var s=_getAnswer(e,e.current.form.options.forEachAnswer,e.current.fsRespId);e.forEach=[],_.each(s.value,function(o){e.forEach.push({verbose:o,value:o})})}else if(e.current.form.blocks[0].options.repeatable){var n=e.formResps.chain().find({fsRespId:e.current.fsResp.$loki}).find({formId:e.current.form.id}).data();0===n.length?(e.current.formResp=e.formResps.insert({fsSlug:e.formstack.slug,fsRespId:e.current.fsResp.$loki,formId:e.current.form.id,formIndex:e.current.formIndex,formRepeatItem:null,ccreated:$vpApi.getTimestamp(),cupdate:$vpApi.getTimestamp()}),$vpApi.db.save()):e.current.formResp=n[0],e.current.form.blockResps=e.blockResps.chain().find({fsRespId:e.current.fsResp.$loki}).find({formId:e.current.form.id}).data()}else{var n=e.formResps.chain().find({fsRespId:e.current.fsResp.$loki}).find({formId:e.current.form.id}).data();0===n.length?(e.current.formResp=e.formResps.insert({fsSlug:e.formstack.slug,fsRespId:e.current.fsResp.$loki,formId:e.current.form.id,formIndex:e.current.formIndex,formRepeatItem:null,cupdate:$vpApi.getTimestamp()}),$vpApi.db.save()):e.current.formResp=n[0];var c=e.blockResps.chain().find({fsRespId:e.current.fsResp.$loki}).find({formRespId:e.current.formResp.$loki}).find({blockId:e.current.block.id}).data();c.length>0&&(e.current.blockResp=c[0])}else if("app.form-foreach"===o.current.name)e.current.form=_.find(e.formstack.forms,function(e){return e.id===parseInt(t.formId,10)}),e.current.formIndex=_.indexOf(e.formstack.forms,e.current.form),e.current.page=t.page,e.current.form.forEach=null,e.current.form.repeatItem=null;else{if("new"===t.formRespId.split("-")[0]){var i=t.formRespId.split("-");if(2===i.length){var a=parseInt(i[1],10);e.current.form=_.find(e.formstack.forms,function(e){return e.id===a}),e.current.formIndex=_.indexOf(e.formstack.forms,e.current.form)}else{var a=null;e.current.form=e.formstack.forms[0],e.current.formIndex=0}}else t.formRespId.length<1&&console.error("No formRespId found in the URL"),e.current.formResp=e.formResps.get(parseInt(t.formRespId,10)),e.current.formIndex=e.current.formResp.formIndex,e.current.form=e.formstack.forms[e.current.formIndex];if("new"===t.blockRespId.split("-")[0]){var i=t.blockRespId.split("-");if(2===i.length){var l=parseInt(i[1],10);e.current.block=_.find(e.current.form.blocks,function(e){return e.id===l}),e.current.blockIndex=_.indexOf(e.current.form.blocks,e.current.block)}else e.current.block=e.current.form.blocks[0],e.current.blockIndex=0}else t.blockRespId.length<1&&console.error("No blockRespId found in the URL"),e.current.blockResp=e.blockResps.get(parseInt(t.blockRespId,10)),e.current.blockIndex=e.current.blockResp.blockIndex,e.current.block=e.current.form.blocks[e.current.blockIndex]}if(e.current.form.options.forEach&&e.current.form.options.forEach.length>0);else if(e.current.form.options.forEachAnswer&&e.current.form.options.forEachAnswer.length>0){var f,s=_getAnswer(e,e.current.form.options.forEachAnswer,e.current.fsRespId);e.current.form.forEach=[],_.each(s.value,function(o){f=$formstack.getChoice(e.current.form.options.forEachAnswer,o),e.current.form.forEach.push(f)})}if(e.current.form.forEach&&loadFormForEachItems(e),e.current.block)if(e.current.block.options.forEach&&e.current.block.options.forEach.length>0);else if(e.current.block.options.forEachAnswer&&e.current.block.options.forEachAnswer.length>0){var s=_getAnswer(e,e.current.block.options.forEachAnswer,e.current.fsRespId);e.current.block.forEach=[],_.each(s.value,function(o){e.current.block.forEach.push({verbose:o,value:o})})}e.current.formResp&&"undefined"!=typeof e.current.formResp.formForEachItem&&(f=$formstack.getChoice(e.current.formResp.formForEachQuestionSlug,e.current.formResp.formForEachItem),e.current.form.forEachItem=f)},changeState=function(e,o,t){{var r,s,n,c,i,a="app.",l=null,f=null;e.current.form.blocks}if(o&&o.params&&o.params.fsSlug&&(f=o.params.fsSlug),getAnswer=function(o){fsRespId=e.current.fsResp.$loki,answers=$vpApi.db.getCollection("answer");var t=$vpApi.db.getCollection("answer").chain().find({questionSlug:o}).find({fsRespId:fsRespId}).data();return t.length>1?(console.log("found more than one answer, returns the first one."),console.table(t),t=t[0]):1===t.length?t=t[0]:(t=null,console.error("[]getAnswer] No answer found")),console.log("Found answer: "+t),t},"forward"===t||"repeat-block"===t||"repeat-form"===t){if("forward"===t?s="end"===e.current.page||"intro"===e.current.page?null:this.getEligibleBlock(t,e.current.form,e.current.blockIndex):("repeat-block"===t||"repeat-form"===t)&&(s=e.current.block),s){console.log("[LinearBlockCtrl.saveBlock()] found next block, setting state");var u,d;if("forward"===t){formRespId=e.current.formResp.$loki;var p=e.blockResps.chain().find({blockId:s.id}).find({formRespId:e.current.formResp.$loki}).data();u=p.length>0?p.slice(-1)[0].$loki:"new-"+s.id}else if("repeat-form"===t){if("map-form"===e.current.form.type)return void $location.hash("intro");e.current.formRepeatItem=null,formRespId="new-"+e.current.form.id,u="new-"+s.id}else if("repeat-block"===t){if("map-form"===e.current.form.type){var u="new-"+e.current.block.id;return void $location.hash([e.current.formResp.$loki,u,0].join("/"))}formRespId=e.current.formResp.$loki,u="new-"+s.id,l="0"}return a+=e.current.form.type?e.current.form.type:"form",e.current.form.forEach&&_.indexOf(e.current.form.blocks,s)===e.current.form.blocks.length-1&&(a+="-foreach",d="end"),r={fsSlug:e.formstack.slug,fsRespId:e.current.fsResp.$loki,formRespId:formRespId,formId:e.current.form.id,blockRespId:u,hash:l,page:d,qIndex:l},void o.go(a,r)}console.log("[LinearBlockCtrl.saveBlock()] No more blocks in this form, so grabbing the first block of the next form");var m,s,g,n=this.getEligibleForm(t,e.current.formIndex,f);return n?(a+=n.type?n.type:"form",formResps=e.formResps.chain().find({fsRespId:e.current.fsResp.$loki}).find({formId:n.id}).simplesort("created").data(),m=formResps.length>0?formResps[0].$loki:"new-"+n.id,s=getEligibleBlock("forward",n,-1),s.forEach?console.error("Not implemented"):(p=e.blockResps.chain().find({fsRespId:e.current.fsResp.$loki}).find({formRespId:m}).find({blockId:s.id}).simplesort("$loki",!1).data(),g=p.length>0?p[0].$loki:"new-"+s.id),(n.options.forEach||n.options.forEachAnswer)&&(a+="-foreach",l="intro"),r={fsSlug:e.formstack.slug,fsRespId:e.current.fsResp.$loki,formId:n.id,formRespId:m,blockRespId:g,hash:l,page:l,qIndex:"intro"},void o.go(a,r)):(console.log("[LinearBlockCtrl.saveBlock()] No more forms. You are done."),e.current.fsResp.status="complete",e.current.fsResp.cupdate=$vpApi.getTimestamp(),$vpApi.db.save(),console.log("[LinearBlockCtrl.saveBlock()] No more forms. You are done."),void o.go("app.complete",{fsRespId:e.current.fsResp.$loki}))}if("back"===t)if(b=this.getEligibleBlock(t,e.current.form,e.current.blockIndex)){console.log("[LinearBlockCtrl.saveBlock()] found next block");var h=e.blockResps.chain().find({blockId:b.id}).find({formRespId:e.current.formResp.$loki}).data();i=h.length>0?h.slice(-1)[0]:{id:"new-"+b.id},a+=e.current.form.type?e.current.form.type:"form",r={fsSlug:e.formstack.slug,fsRespId:e.current.fsResp.$loki,formRespId:e.current.formResp.$loki,blockRespId:i.$loki,hash:l}}else{if(console.log("[LinearBlockCtrl.saveBlock()] This is the first block in the form"),prevForm=this.getEligibleForm(t,e.current.formIndex,f),!prevForm)return console.log("[LinearBlockCtrl.saveBlock()] No more forms. You are done."),void o.go("app.home");console.log("[LinearBlockCtrl.saveBlock()] Found prev form");var c=e.formResps.chain().find({fsRespId:e.current.fsResp.$loki}).find({formId:prevForm.id}).data();c=c.length>1?c.slice(-1)[0]:1===c.length?c[0]:{id:"new-"+prevForm.id};var b=this.getEligibleBlock(t,prevForm,prevForm.blocks.length),i=e.blockResps.chain().find({blockId:b.id}).find({formRespId:c.$loki}).data();i=i.length>1?i.slice(-1)[0]:1===i.length?i[0]:{id:"new-"+b.id},a+=prevForm.type?prevForm.type:"form",(prevForm.options.forEach||prevForm.options.forEachAnswer)&&(a+="-foreach",d="intro"),r={fsSlug:e.formstack.slug,fsRespId:e.current.fsResp.$loki,formRespId:c.$loki,formId:prevForm.id,blockRespId:i.$loki,hash:d,page:d}}e.newStateParams=r,o.go(a,r)},_getAnswer=function(e,o,t){t=t||e.current.fsResp.$loki,answers=$vpApi.db.getCollection("answer");var r=$vpApi.db.getCollection("answer").chain().find({questionSlug:o}).find({fsRespId:t}).data();return r.length>1?(console.log("found more than one answer, returns the first one."),console.table(r),r=r[0]):r=1===r.length?r[0]:null,console.log("Found answer: "+r),r},getEligibleBlock=function(direction,form,currentBlockIndex){function findEligibleBlock(direction){return console.log("[findEligibleNextBlock] looking for blockIndex "+currentBlockIndex),block="forward"===direction?blocks[currentBlockIndex+1]:blocks[currentBlockIndex-1],block?"undefined"!=typeof block.options.skipWhen&&(rs=eval(block.options.skipWhen),rs?(console.log("[_getNextBlock()] I need to skip this block and get the next one"),"forward"===direction?currentBlockIndex++:currentBlockIndex--,findEligibleBlock(direction)):console.log("[_getNextBlock()] I can use this block.")):console.log("[_getNextBlock] there are no more blocks on this form"),block}var out,block,rs,blocks=form.blocks;return block=findEligibleBlock(direction)},loadFormForEachItems=function(e){var o;_.each(e.current.form.forEach,function(o){o.formResp=e.formResps.chain().find({fsRespId:e.current.fsResp.$loki}).find({formId:e.current.form.id}).find({formRepeatItem:o.value}).data(),0===o.formResp.length?(console.log("Create a formResp for "+o),o.formResp=e.formResps.insert({fsSlug:e.formstack.slug,fsRespId:e.current.fsResp.$loki,formId:e.current.form.id,formIndex:e.current.formIndex,formRepeatItem:o.value,formForEachItem:o.value,formForEachQuestionSlug:e.current.form.options.forEachAnswer,ccreated:$vpApi.getTimestamp(),cupdate:$vpApi.getTimestamp()}),$vpApi.db.save()):o.formResp=o.formResp[0],o.blockResps=e.blockResps.chain().find({fsRespId:e.current.fsResp.$loki}).find({formRespId:o.formResp.$loki}).simplesort("created").data(),o.blockResps.length>0?(o.formRespId=o.blockResps[0].formRespId,o.blockRespId=o.blockResps[0].$loki,o.isNew=!1):(o.formRespId="new-"+e.current.form.id,o.blockRespId="new-"+e.current.form.blocks[0].id,o.isNew=!0),o.form="form"});var t=e.formResps.chain().find({formId:e.current.form.id}).find({fsRespId:e.current.fsResp.$loki});_.each(e.current.form.forEach,function(e){t.find({formForEachItem:{$ne:e.value}})}),o=t.data(),console.log("Stale Form Resps"),console.table(o),_.each(o,function(e){$formResp.delete(e.$loki)})},getEligibleForm=function(direction,currentFormIndex,fsSlug){function findEligibleForm(direction){return console.log("[findNextEligibleForm] looking for formIndex "+currentFormIndex),form="forward"===direction?forms[currentFormIndex+1]:forms[currentFormIndex-1],form?"undefined"!=typeof form.options.skipWhen&&(rs=eval(form.options.skipWhen),rs?(console.log("[_findNextEligibleForm()] I need to skip this form and get the next one"),"forward"===direction?currentFormIndex++:currentFormIndex--,findEligibleForm(direction)):console.log("[_findNextEligibleForm()] I can use this form.")):console.log("[_getNextBlock] there are no more forms on this form"),form}var forms=$vpApi.getFormstack(fsSlug).forms;return form=findEligibleForm(direction)},loadAnswers=function(e,o,t,r){var s=!1;t+="",r+="",("new"===o||"new"===t.split("-")[0]||"new"===r.split("-")[0])&&(s=!0),e.previousAnswers=s?[]:e.answers.chain().find({fsRespId:parseInt(o,10)}).find({formRespId:parseInt(t,10)}).find({blockRespId:parseInt(r,10)}).data(),_.each(e.current.block.questions,function(o){var t=_.find(e.previousAnswers,function(e){return e.questionId===o.id});t?(o.value=t.value,o.previousValue=t.value,o.answerCid=t.$loki):"undefined"!=typeof o.options["default"]?(o.value=o.options["default"],o.previousValue=o.options["default"],o.answerCid=null):(o.value="",o.previousValue="",o.answerCid=null)})},parseHash=function(e){var o;if("intro"===e||"end"===e)return e;var t=e.split("/");return 3===t.length?(formRespId=t[0],blockRespId=t[1],qIndex=parseInt(t[2]),o=[formRespId,blockRespId,qIndex]):o=e,o},{setState:setState,changeState:changeState,getAnswer:_getAnswer,getEligibleForm:getEligibleForm,getEligibleBlock:getEligibleBlock,loadAnswers:loadAnswers,parseHash:parseHash}}]),angular.module("vpApi.services",[]).service("$vpApi",["$rootScope","$http","config",function(e,o,t){var r=this,s=t.apiBaseUri;this.username="",this.user={},this.users,this.dbLoaded=!1,this.dbinit=function(){r.db=data.db,r.user=data.user,r.users=data.db.getCollection("user"),r.dbLoaded=!0,r.db.getCollection("formResp").on("insert",function(e){e.id=r.generateUUID()}),r.db.getCollection("fsResp").on("insert",function(e){e.id=r.generateUUID()}),r.db.getCollection("blockResp").on("insert",function(e){e.id=r.generateUUID()}),r.db.getCollection("answer").on("insert",function(e){e.id=r.generateUUID()})},this.generateUUID=function(){var e=(new Date).getTime(),o="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(o){var t=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==o?t:3&t|8).toString(16)});return o},this.getApp=function(e){var o=r.db.getCollection("app"),t=null;return t=void 0==e||null==e?o.find()[0]:o.find({slug:e})[0]},this.getFormstack=function(e){var o=null,t=r.db.getCollection("formstack");return o=void 0==e||null==e?t.find()[0]:t.find({slug:e})[0],o||console.error("[$vpApi.getFormstack()] Could not find formstack"),o},this.getTimestamp=function(){return(new Date).toISOString()},this.serialize=function(e){var o=[];for(var t in e)e.hasOwnProperty(t)&&o.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return o.join("&")},this.authenticate=function(t,n,c){var i=s+"authenticate/",a={};o.post(i,t,a).success(function(o){var s=r.users.find({username:t.username});0===s.length?user=r.users.insert({username:t.username,token:o.token}):(user=s[0],user.token=o.token,user.username=t.username,r.users.update(user)),r.user=user,r.db.save(),localStorage.setItem("user",JSON.stringify(r.user)),e.$broadcast("authenticated",{onSuccess:n})}).error(function(e,o){c(e,o)})},this.fetch=function(e,t,r,n){var c=s+e+"/",i=this.serialize(t);c+="?"+i;var a={headers:{Authorization:"Token "+this.user.token}};o.get(c,a).success(function(e,o){r(e,o)}).error(function(e,o){n(e,o)})},this.post=function(e,t,r,n){{var c=s+e+"/";({headers:{Authorization:"Token "+this.user.token}})}o({url:c,method:"POST",data:t,headers:{Authorization:"Token "+this.user.token,"Content-Type":"application/json; charset=utf-8"}}).success(function(e,o){r(e,o)}).error(function(e,o){n(e,o)})},this.showCollection=function(e){console.log("SHOW TABLE: "+e),console.table(data.db.getCollection(e).data)},this.dbinit()}]).service("$user",["$rootScope","$vpApi","$app","$formstack","$profile",function(e,o,t,r,s){e.$on("authenticated",function(r,n){s.fetch(function(){o.db.save(),allowedApps=o.user.profile.allowed_apps,allowedApps.length>0?appSlug=allowedApps[0]:console.error("There are no allowed Apps for this user."),t.fetchBySlug(appSlug,function(t){formstacks=t.formstacks,oldStacks=o.db.getCollection("formstack").find(),_.each(oldStacks,function(e){o.db.getCollection("formstack").remove(e)}),_.each(formstacks,function(e){e.appId=t.id,e.appSlug=t.slug,o.db.getCollection("formstack").insert(e),item={status:"success",attempts:1,lastAttempt:o.getTimestamp(),method:"GET",resourceUri:"/api/v2/pforms/formstack/"+e.id,resourceId:e.id},o.db.getCollection("statusTable").insert(item)}),o.db.save(),e.$broadcast("apploaded"),n.onSuccess()},function(e){console.log("[$user] failed to fetch formstack"),console.log(e)})},function(){console.log("Error fetching profile.")})})}]).service("$profile",["$http","$vpApi","config",function(e,o,t){var r=t.apiBaseUri;this.fetch=function(t,s){var n=r+"account/info/?user__username=",c=o.user.token,i={headers:{Authorization:"Token "+c}};e.get(n+o.user.username,i).success(function(e){o.user.profile=e[0],o.users.update(o.user),t()}).error(function(){s()})}}]).service("$app",["$vpApi","$rootScope",function(e){var o=this;this.resource_name="pforms/get/app",this._fetchSuccess=function(t){o.objects=t;var r=e.db.getCollection("app"),s=r.find({slug:t[0].slug});s.length>0&&r.remove(s),r.insert(t[0])},this._fetchFail=function(e,t){console.log("Failed to fetch "+o.resource_name+". Returned Status: "+t),console.log(e)},this.fetchBySlug=function(t,r,s){HAS_CONNECTION&&e.fetch(this.resource_name,{slug:t},function(s,n){o.objects=s;var c=e.db.getCollection("app"),i=c.find({slug:t});i.length>0&&c.remove(i),c.insert(s[0]),r(s[0],n)},function(e,t){console.log("Failed to fetch "+o.resource_name+". Returned Status: "+t),console.log(e),s(e,t)})},this.updateBySlug=function(t,r,s,n){var c=o.resource_name,i={slug:t};r&&(i.modified_gte=r,c="pforms/app"),e.fetch(c,i,function(e,o){app=null,1===e.length&&(app=e[0]),s(app,o,t)},function(e,r){o._fetchFail(e,r,t),n(e,r)})}}]).service("$formstack",["$vpApi",function(e){var o=this;this.resource_name="pforms/formstack",this.formRepeatItem,this._fetchSuccess=function(t){o.objects=t;var r=e.db.getCollection("formstack"),s=r.find({slug:t[0].slug});s.length>0&&r.remove(s),r.insert(t[0])},this._fetchFail=function(e,t){console.log("Failed to fetch "+o.resource_name+". Returned Status: "+t),console.log(e)},this.fetchBySlug=function(t,r,s){HAS_CONNECTION&&e.fetch(this.resource_name,{slug:t},function(s,n){o.objects=s;var c=e.db.getCollection("formstack"),i=c.find({slug:t});i.length>0&&c.remove(i),c.insert(s[0]),r(s[0],n)},function(e,t){console.log("Failed to fetch "+o.resource_name+". Returned Status: "+t),console.log(e),s(e,t)})},this.updateBySlug=function(t,r,s,n){var c={slug:t};r&&(c.modified_gte=r),e.fetch(this.resource_name,c,function(e,r){var n=null;e.length>0&&(o._fetchSuccess(e,r,t),n=e[0]),s(n,r,t)},function(e,r){o._fetchFail(e,r,t),n(e,r,t)})},this.getQuestionBySlug=function(o){var t,r=e.db.getCollection("formstack").data[0];return _.find(r.forms,function(e){return blockRes=_.find(e.blocks,function(e){return qRes=_.find(e.questions,function(e){return e.slug===o?(t=e,!0):void 0})})}),t},this.getChoice=function(e,t){var r,s=o.getQuestionBySlug(e);return r=_.find(s.choices,function(e){return e.value===t}),r||(r={verbose:"User Enter: "+t,value:t}),r},this.getSlugs=function(){var o=[];return formstacks=e.db.getCollection("formstack").data,o=_.map(formstacks,function(e){return e.slug})}}]).service("$fsResp",["$vpApi","$rootScope",function(e,o){var t=this;o.$on("db_loaded",function(){this.objects=e.db.getCollection("fsResp")}),this.delete=function(r){t.objects=e.db.getCollection("fsResp");var s=t.objects.get(r);t.objects.remove(s);var n=e.db.getCollection("formResp").find({fsRespId:r}),c=e.db.getCollection("blockResp").find({fsRespId:r}),i=e.db.getCollection("answer").find({fsRespId:r});_.each(n,function(o){e.db.getCollection("formResp").remove(o)}),_.each(c,function(o){e.db.getCollection("blockResp").remove(o)}),_.each(i,function(o){e.db.getCollection("answer").remove(o)}),e.db.save(),console.log("[$fsResp.delete()] Deleted all responses. About to broadcast fsResp-deleted for "+r),o.$broadcast("fsResp-deleted",{fsRespId:r})},this.getFullResp=function(o){var t,r,s;return out={},fsResp=angular.copy(e.db.getCollection("fsResp").get(o)),out.id=fsResp.id,out.fsId=fsResp.fsId,out.client_created=fsResp.ccreated,out.client_updated=fsResp.cupdate,out.formResps=[],r=angular.copy(e.db.getCollection("formResp").find({fsRespId:o})),_.each(r,function(r){r.client_created=r.ccreated,r.client_updated=r.cupdate,t=angular.copy(e.db.getCollection("blockResp").chain().find({fsRespId:o}).find({formRespId:r.$loki}).data()),_.each(t,function(t){s=angular.copy(e.db.getCollection("answer").chain().find({fsRespId:o}).find({formRespId:r.$loki}).find({blockRespId:t.$loki}).data()),_.each(s,function(e){void 0===e.value&&(e.value=null)}),t.answers=s,t.client_created=t.ccreated,t.client_updated=t.cupdate,_.each(t.answers,function(e){e.client_created=e.ccreated,e.client_updated=e.cupdate})}),r.blockResps=t,r.cid=r.$loki,out.formResps.push(r)}),out}}]).service("$formResp",["$vpApi",function(e){this.resource_name="pforms/form-response",this.delete=function(o){var t=e.db.getCollection("formResp").get(o);if(!t)return void console.warn("Form Response does not exist: "+o);var r=e.db.getCollection("blockResp").find({formRespId:o}),s=e.db.getCollection("answer").find({formRespId:o});e.db.getCollection("formResp").remove(t),_.each(r,function(o){e.db.getCollection("blockResp").remove(o)}),_.each(s,function(o){e.db.getCollection("answer").remove(o)}),e.db.save()}}]).service("$blockResponse",["$formstack","$block","$rootScope","$answers","$formResponse",function(e,o,t){this.resource_name="pforms/block-response",t.$on("answer-created",function(){})}]).service("$answers",["$form","$rootScope","$filter","$vpApi","config",function(){this.resource_name="pforms/answer"}]),angular.module("vpApi.services").service("$sync",["$rootScope","$http","config","$vpApi","$app","$formstack","$fsResp","$ionicLoading",function(e,o,t,r,s,n,c){var i=this;this.toasDuration=3e3,this.intervalHandle=null,this.collections=["fsResp","formResp","blockResp","answer"],this.lastUpdate=localStorage.getItem("lastUpdate"),this.statusTable=r.db.getCollection("statusTable"),this.lastUpdate&&(this.lastUpdate=new Date(this.lastUpdate)),this.run=function(o){if(window.HAS_CONNECTION!==!0||!r.user)return void console.warn("No network found, sync cancelled.");onSucess=function(t,r){console.log("[$sync.run.OnSucess]"),e.$broadcast("sync-complete",t),o(t,r)},onError=function(){console.log("[$sync.run.OnError]")};var t=angular.copy(r.db.getCollection("fsResp").find({status:"submitted"}));0===t.length&&onSucess([],"There are no submitted formstack to sync."),this.submitFormstacks(t,onSucess,onError),i.clearSyncedFormstacks(),i.updateReadOnly(),e.$broadcast("sync-complete")},this.submitFormstacks=function(e,o){var t,s,n,a=0;submitSuccess=function(t){console.log("Submit successful: "+t.id),console.log(t),item=i.statusTable.find({resourceId:t.id})[0],item.status="success",s=r.db.getCollection("fsResp").find({id:t.id})[0],s.status="synced",s.syncedAt=r.getTimestamp(),r.db.save(),a++,a===e.length&&o([1,2],"Finished submitting formstacks.")},submitFail=function(t,s){console.log("I failed "+s),item=i.statusTable.find({resourceId:t.id}),item.status="fail",r.db.save(),a++,a===e.length&&o({},"Finished submitting formstacks.")},_.each(e,function(e){t=c.getFullResp(e.$loki),n="pforms/formstack/"+t.fsId+"/submit",console.log("About to post to "+n),item=i.statusTable.find({resourceId:e.id}),0===item.length?(item={status:"pending",attempts:1,lastAttempt:r.getTimestamp(),method:"POST",resourceUri:n,resourceId:e.id},i.statusTable.insert(item)):(item.status="pending",item.attempts++,item.lastAttempt=r.getTimestamp(),i.statusTable.update(item)),r.db.save(),r.post(n,t,submitSuccess,submitFail)})},this.clearSyncedFormstacks=function(){var e,o,s,n=new Date,a=r.db.getCollection("fsResp").chain().find({status:"synced"}).where(function(r){return o=new Date(r.syncedAt),e=(n-o)/1e3,console.log(e),e>t.ARCHIVE_DT}).data();_.each(a,function(e){s=i.statusTable.find({resourceId:e.id})[0],i.statusTable.remove(s),c.delete(e.$loki)})},this.updateReadOnly=function(){console.log("I NEED TO UPDATE MEDIA AND TILES???"),appObj=i._updateApp();var o=e.$on("app-updated",function(e,t){console.log("in app-updated listener");var r,s,c=n.getSlugs();s=t.app.formstacks.length>0&&t.app.formstacks[0].slug?_.map(t.app.formstacks,function(e){return e.slug}):t.app.localFormstacks;var a=_.difference(s,c),l=_.difference(c,s);console.log("newFormstacks"),console.table(a),console.log("staleFormstacks"),console.table(l),r=c.concat(a),console.log("formstack slugs to update: "),console.table(r),i._updateFormstacks(r),o()})},this._updateApp=function(){var o,t=r.getApp();console.log("Checking for app updates "+t.slug);var n=i.statusTable.chain().find({resourceId:t.id}).find({method:"GET"}).find({status:"success"}).simplesort({lastAttempt:"asc"}).data();n.length>1?console.error("[sync._updateApp] More than 1 entry found in statusTable for app "):1===n.length?(o=n[0],last_ts=n[0].lastAttempt,o.entrys++,o.status="pending",o.lastAttempt=r.getTimestamp(),i.statusTable.update(o)):(last_ts=new Date(2015,1,1).toISOString(),o={status:"pending",entrys:1,lastAttempt:r.getTimestamp(),method:"GET",resourceUri:"/api/v2/pforms/app/"+t.id,resourceId:t.id},i.statusTable.insert(o)),r.db.save(),success=function(o){t=r.getApp(),console.log(null===o?"[_updateApp] No updates found":"[_updateApp] app updated: "+t.slug);var s=i.statusTable.chain().find({resourceId:t.id}).find({method:"GET"}).find({status:"pending"}).simplesort({lastAttempt:"asc"}).data()[0];s.status="success",i.statusTable.update(s),r.db.save(),e.$broadcast("app-updated",{app:t})},error=function(e,o){console.warn("[_updateApp] update failed, status "+o),console.log(e)},console.log("Checking for updates to app "+t.slug),s.updateBySlug(t.slug,last_ts,success,error)},this._updateFormstacks=function(e){_.each(e,function(e){var o,t=r.db.getCollection("formstack").find({slug:e})[0];success=function(e,o,s){t=r.db.getCollection("formstack").find({slug:s})[0],console.log(null===e?"[updateReadOnly] No updates found":"[updateReadOnly] formstack updated: "+t.slug);var n=i.statusTable.chain().find({resourceId:t.id}).find({method:"GET"}).find({status:"pending"}).simplesort({lastAttempt:"asc"}).data(),c={};1===n.length?(c=n[0],c.status="success",i.statusTable.update(c)):n.length>0&&console.warn("[sync._updateFormstacks()] Found more than 1 attempt record in the statusTable."),r.db.save()},error=function(e,o){console.warn("[updateReadOnly] update failed, status "+o),console.log(e)},console.log("Checking for updates to formstack "+t.slug);var s=i.statusTable.chain().find({resourceId:t.id}).find({method:"GET"}).find({status:"success"}).simplesort({lastAttempt:"asc"}).data();s.length>0?(o=s[0],last_ts=s[0].lastAttempt,o.attempts++,o.status="pending",o.lastAttempt=r.getTimestamp(),i.statusTable.update(o)):(last_ts=new Date(2015,1,1).toISOString(),o={status:"pending",attempts:1,lastAttempt:r.getTimestamp(),method:"GET",resourceUri:"/api/v2/pforms/formstack/"+t.id,resourceId:t.id},i.statusTable.insert(o)),r.db.save(),n.updateBySlug(t.slug,last_ts,success,error)
})}}]);