angular.module("vpApi.services",[]).service("$vpApi",["$rootScope","$http","config",function(e,o,r){var n=this,t=r.apiBaseUri;this.username="",this.user={},this.users,this.dbLoaded=!1,this.dbinit=function(e){return n.db=data.db,n.user=data.user,n.users=data.db.getCollection("user"),void(n.dbLoaded=!0)},this.getFormstack=function(){var e=null;try{e=n.db.getCollection("formstack").find({slug:n.user.profile.allowed_formstacks[0]})[0]}catch(o){console.error("[$vpApi.getFormstack()] Could not find formstack"),console.log(o)}return e},this.getTimestamp=function(){return(new Date).toISOString()},this.serialize=function(e){var o=[];for(var r in e)e.hasOwnProperty(r)&&o.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return o.join("&")},this.authenticate=function(r,s,c){var i=t+"authenticate/",l={};o.post(i,r,l).success(function(o){var t=n.users.find({username:r.username});0===t.length?user=n.users.insert({username:r.username,token:o.token}):(user=t[0],user.token=o.token,user.username=r.username,n.users.update(user)),n.user=user,n.db.save(),localStorage.setItem("user",JSON.stringify(n.user)),e.$broadcast("authenticated",{onSuccess:s})}).error(function(e,o){c(e,o)})},this.fetch=function(e,r,n,s){var c=t+e+"/",i=this.serialize(r);c+="?"+i;var l={headers:{Authorization:"Token "+this.user.token}};o.get(c,l).success(function(e,o){n(e,o)}).error(function(e,o){s(e,o)})},this.post=function(e,r,n,s){{var c=t+e+"/";({headers:{Authorization:"Token "+this.user.token}})}o({url:c,method:"POST",data:r,headers:{Authorization:"Token "+this.user.token}}).success(function(e,o){n(e,o)}).error(function(e,o){s(e,o)})},this.dbinit()}]).service("$user",["$rootScope","$vpApi","$formstack","$profile",function(e,o,r,n){e.$on("authenticated",function(e,t){n.fetch(function(){o.db.save(),allowedFormstacks=o.user.profile.allowed_formstacks,allowedFormstacks.length>0?formstackSlug=allowedFormstacks[0]:console.error("There are no allowed formstacks for this user."),r.fetchBySlug(formstackSlug,function(){o.db.save(),t.onSuccess()},function(e){console.log("[$user] failed to fetch formstack"),console.log(e)})},function(){console.log("Error fetching profile.")})})}]).service("$profile",["$http","$vpApi","config",function(e,o,r){var n=r.apiBaseUri;this.fetch=function(r,t){var s=n+"account/info/?user__username=",c=o.user.token,i={headers:{Authorization:"Token "+c}};e.get(s+o.user.username,i).success(function(e){o.user.profile=e[0],o.users.update(o.user),r()}).error(function(){t()})}}]).service("$formstack",["$vpApi",function(e){var o=this;this.resource_name="pforms/formstack",this.formRepeatItem,this._fetchSuccess=function(r){o.objects=r;var n=e.db.getCollection("formstack"),t=n.find({slug:r[0].slug});t.length>0&&n.remove(t),n.insert(r[0])},this._fetchFail=function(e,r){console.log("Failed to fetch "+o.resource_name+". Returned Status: "+r),console.log(e)},this.fetchBySlug=function(r,n,t){HAS_CONNECTION&&e.fetch(this.resource_name,{slug:r},function(t,s){o.objects=t;var c=e.db.getCollection("formstack"),i=c.find({slug:r});i.length>0&&c.remove(i),c.insert(t[0]),n(t[0],s)},function(e,r){console.log("Failed to fetch "+o.resource_name+". Returned Status: "+r),console.log(e),t(e,r)})},this.updateBySlug=function(r,n,t){var s={slug:r};e.fetch(this.resource_name,s,function(e,r){o._fetchSuccess(e,r),n(e[0])},function(e,r){o._fetchFail(e,r),t(e,r)})}}]).service("$fsResp",["$vpApi","$rootScope",function(e,o){var r=this;this.resource_name="pforms/formstack-response",o.$on("db_loaded",function(){this.objects=e.db.getCollection("fsResp")}),this.delete=function(o){var n=r.objects.get(o);r.objects.remove(n);var t=e.db.getCollection("formResp").find({fsRespId:o}),s=e.db.getCollection("blockResp").find({fsRespId:o}),c=e.db.getCollection("answer").find({fsRespId:o});_.each(t,function(o){e.db.getCollection("formResp").remove(o)}),_.each(s,function(o){e.db.getCollection("blockResp").remove(o)}),_.each(c,function(o){e.db.getCollection("answer").remove(o)}),e.db.save()}}]).service("$formResp",["$vpApi",function(){this.resource_name="pforms/form-response"}]).service("$blockResponse",["$formstack","$block","$rootScope","$answers","$formResponse",function(e,o,r){this.resource_name="pforms/block-response",r.$on("answer-created",function(){})}]).service("$answers",["$form","$rootScope","$filter","$vpApi","config",function(){this.resource_name="pforms/answer"}]).service("$mediacache",["$vpApi","$formstack","$http",function(e,o,r){var n=this;n.isCached=!1,this.run=function(){var o=n.getFilenames();_.each(o,function(o){r({method:"GET",withCredentials:!0,url:o}).success(function(r){var n=e.db.getCollection("media"),t=n.find({fname:o});t.length>0?(t.cupdate=e.getTimestamp(),n.update(t)):(t={fname:o,data:r,cupdate:e.getTimestamp()},n.insert(t)),e.db.save()}).error(function(){console.log("Could not load media file ")})})},this.getFilenames=function(){var o=e.getFormstack(),r=[];return _.each(o.forms,function(e){_.each(e.blocks,function(e){_.each(e.questions,function(e){e.options.geojsonChoices&&e.options.geojsonChoices.url&&r.push(e.options.geojsonChoices.url)})})}),r=_.uniq(r),console.log("[getFilenames] Files to cache: "),console.log(r),r}}]).service("$tilecache",["$vpApi","$formstack","$timeout",function(e,o,r){var n=this;this.regions=[],this.cacheTimer={start:null,stop:null,elasped:null},this.isCached=function(){var e=localStorage.getItem("tilesCached"),o="true"===e?!0:!1;return o},this.getMaxCacheZoom=function(){var o,r=e.getFormstack(),n=_.find(r.forms,function(e){return"map-form"===e.type});return o=n?n.options.maxCacheZoom:null},this.getRegions=function(){var o=[],r=e.getFormstack();return _.each(r.forms,function(e){"map-form"===e.type&&e.options.regions&&(o=_.uniq(o.concat(e.options.regions)))}),n.regions=o,o},this.getTileSources=function(){var o=[],r=e.getFormstack();return _.each(r.forms,function(e){"map-form"===e.type&&e.options.tileSources&&(o=_.uniq(o.concat(e.options.tileSources)))}),n.tileSources=o,o},this.loadRegions=function(e,o){if(0===n.regions.length)return n.getRegions(),void(0===n.regions.length);var r=n.getMaxCacheZoom(),t=n.offlineLayer.calculateNbTiles(r,n.regions);console.log("Will be saving: "+t+" tiles"),n.offlineLayer.saveRegions(n.regions,r,function(){console.log("[saveRegions] onStarted")},function(){console.log("[saveRegions] onSuccess"),n.cacheTimer.stop=new Date,n.cacheTimer.elasped=n.cacheTimer.stop-n.cacheTimer.start,console.log("Cache timer elapsed time (min): "+n.cacheTimer.elasped/1e3/60),localStorage.setItem("tilesCached","true"),e()},function(e){console.log("onError"),console.log(e),o()})},this.run=function(e,o){n.cacheTimer.start=new Date;var t=n.getTileSources()[0];onError=function(e,r,n){console.log("[$tilecache.run.onError()] "),localStorage.setItem("tilesCached","false"),console.log(e),console.log(r),console.log(n),o()};var s=L.map("cache-map").setView([-2.9,-79],13),c={map:s,maxZoom:n.getMaxCacheZoom(),attribution:t.attrib,subdomains:t.subdomain,dbOnly:!0,onReady:function(){console.log("onReady for what?")},onError:function(){console.log("onError for what?")},storeName:t.storeName,dbOption:"IndexedDB"};n.offlineLayer=new OfflineLayer(t.url,c),r(function(){n.loadRegions(e,o)},1e3)},this.clearTiles=function(){console.log("clearing tiles..."),n.offlineLayer.clearTiles(function(){console.log("[clearTiles] success")},function(){console.log("[clearTiles] fail")})},this.clearTilesDb=function(){tilesSources=n.getTileSources(),osTableName=tilesSources[0].storeName,dbName="IDBWrapper-"+osTableName;var e=window.indexedDB.open(dbName,1);e.onerror=function(e){console.log("[openTilesDb] Database error: "+e.target.errorCode)},e.onsuccess=function(){window.db=e.result,console.log("[openTilesDb] Opened "+dbName+" with dataStores"),console.log(window.db.objectStoreNames);var o=window.db.transaction(osTableName,"readwrite").objectStore(osTableName);o.clear().onsuccess=function(){localStorage.removeItem("tilesCached"),console.log("Finished clearing records")}}}}]),angular.module("survey.services",[]).factory("$formUtils",["$vpApi","$location",function($vpApi,$location){var obj=this;return setState=function(e,o,r){if(e.current={fsResp:null,form:null,formIndex:null,formResp:null,block:null,blockIndex:null,blockResp:null,qIndex:null},e.formstack=$vpApi.getFormstack(),e.fsResps=$vpApi.db.getCollection("fsResp"),e.formResps=$vpApi.db.getCollection("formResp"),e.blockResps=$vpApi.db.getCollection("blockResp"),e.answers=$vpApi.db.getCollection("answer"),e.medias=$vpApi.db.getCollection("media"),e.forEach=[],"new"===r.fsRespId?(e.current.form=e.formstack.forms[0],e.current.formIndex=0,e.current.block=e.formstack.forms[0].blocks[0],e.current.blockIndex=0):(e.current.fsResp=e.fsResps.get(parseInt(r.fsRespId,10)),e.current.fsResp||console.error("Could not find Formstack Response: "+r.formRespId)),"app.map-form-foreach"===o.current.name||"app.map-form"===o.current.name){if(e.repeatCount=0,0===$location.hash().length&&$location.hash("intro"),e.hash=$location.hash(),e.medias=$vpApi.db.getCollection("media"),r.formRespId="new",e.selectedFeatures={"type:":"FeatureCollection",features:[]},e.current.form=_.find(e.formstack.forms,function(e){return e.id===parseInt(r.formId,10)}),e.current.block=e.current.form.blocks[0],r.qIndex=r.qIndex||"intro",e.current.formRepeatItem,e.current.formResp&&e.current.formResp.formRepeatItem&&(e.current.formRepeatItem=e.current.formResp.formRepeatItem),e.current.formIndex=_.indexOf(e.formstack.forms,e.current.form),e.current.blockIndex=_.indexOf(e.current.form.blocks,e.current.block),e.current.form.options.forEach&&e.current.form.options.forEach.length>0);else if(e.current.form.options.forEachAnswer&&e.current.form.options.forEachAnswer.length>0){var n=_getAnswer(e,e.current.form.options.forEachAnswer,e.current.fsRespId);e.forEach=[],_.each(n.value,function(o){e.forEach.push({verbose:o,value:o})})}else e.forEach=[{verbose:"",value:"default"}];e.mapQuestion=e.current.block.questions[0],_.each(e.current.block.questions,function(e){e.form={show:!1}})}else{if("new"===r.formRespId.split("-")[0]){var t=r.formRespId.split("-");if(2===t.length){var s=parseInt(t[1],10);e.current.form=_.find(e.formstack.forms,function(e){return e.id===s}),e.current.formIndex=_.indexOf(e.formstack.forms,e.current.form)}else{var s=null;e.current.form=e.formstack.forms[0],e.current.formIndex=0}}else r.formRespId.length<1&&console.error("No formRespId found in the URL"),e.current.formResp=e.formResps.get(parseInt(r.formRespId,10)),e.current.formIndex=e.current.formResp.formIndex,e.current.form=e.formstack.forms[e.current.formIndex];if("new"===r.blockRespId.split("-")[0]){var t=r.blockRespId.split("-");if(2===t.length){var c=parseInt(t[1],10);e.current.block=_.find(e.current.form.blocks,function(e){return e.id===c}),e.current.blockIndex=_.indexOf(e.current.form.blocks,e.current.block)}else e.current.block=e.current.form.blocks[0],e.current.blockIndex=0}else r.blockRespId.length<1&&console.error("No blockRespId found in the URL"),e.current.blockResp=e.blockResps.get(parseInt(r.blockRespId,10)),e.current.blockIndex=e.current.blockResp.blockIndex,e.current.block=e.current.form.blocks[e.current.blockIndex];if(e.current.block.options.forEachAnswer&&e.current.block.options.forEachAnswer.length>0){var n=_getAnswer(e,e.current.block.options.forEachAnswer,e.current.fsRespId);e.forEach=[],_.each(n.value,function(o){e.forEach.push({verbose:o,value:o})})}}},_getAnswer=function(e,o,r){r=r||e.current.fsResp.$loki,answers=$vpApi.db.getCollection("answer");var n=$vpApi.db.getCollection("answer").chain().find({questionSlug:o}).find({fsRespId:r}).data();return n.length>1?(console.log("found more than one answer, returns the first one."),console.table(n),n=n[0]):n=1===n.length?n[0]:null,console.log("Found answer: "+n),n},getEligibleBlock=function(direction,form,currentBlockIndex){function findEligibleBlock(direction){return console.log("[findEligibleNextBlock] looking for blockIndex "+currentBlockIndex),block="forward"===direction?blocks[currentBlockIndex+1]:blocks[currentBlockIndex-1],block?"undefined"!=typeof block.options.skipWhen&&(rs=eval(block.options.skipWhen),console.log("answer "),console.log(getAnswer("marine-activities")),rs?(console.log("[_getNextBlock()] I need to skip this block and get the next one"),"forward"===direction?currentBlockIndex++:currentBlockIndex--,findEligibleBlock(direction)):console.log("[_getNextBlock()] I can use this block.")):console.log("[_getNextBlock] there are no more blocks on this form"),block}var out,block,rs,blocks=form.blocks;return block=findEligibleBlock(direction)},getEligibleForm=function(direction,currentFormIndex){function findEligibleForm(direction){return console.log("[findNextEligibleForm] looking for formIndex "+currentFormIndex),form="forward"===direction?forms[currentFormIndex+1]:forms[currentFormIndex-1],form?"undefined"!=typeof form.options.skipWhen&&(rs=eval(form.options.skipWhen),rs?(console.log("[_findNextEligibleForm()] I need to skip this form and get the next one"),"forward"===direction?currentFormIndex++:currentFormIndex--,findEligibleForm(direction)):console.log("[_findNextEligibleForm()] I can use this form.")):console.log("[_getNextBlock] there are no more forms on this form"),form}var forms=$vpApi.getFormstack().forms;return form=findEligibleForm(direction)},loadAnswers=function(e,o,r,n){console.log("[$formUtils.loadAnswers()]");var t=!1;r+="",n+="",("new"===o||"new"===r.split("-")[0]||"new"===n.split("-")[0])&&(t=!0),e.previousAnswers=t?[]:e.answers.chain().find({fsRespId:parseInt(o,10)}).find({formRespId:parseInt(r,10)}).find({blockRespId:parseInt(n,10)}).data(),_.each(e.current.block.questions,function(o){var r=_.find(e.previousAnswers,function(e){return e.questionId===o.id});console.log("[loadAnswers] Question: "+o.slug),r?(o.value=r.value,o.previousValue=r.value,o.answerCid=r.$loki):"undefined"!=typeof o.options["default"]?(o.value=o.options["default"],o.previousValue=o.options["default"],o.answerCid=null):(o.value="",o.previousValue="",o.answerCid=null)})},parseHash=function(e){var o;if("intro"===e||"end"===e)return e;var r=e.split("/");return 3===r.length?(formRespId=r[0],blockRespId=r[1],qIndex=parseInt(r[2]),o=[formRespId,blockRespId,qIndex]):o=e,o},{setState:setState,getAnswer:_getAnswer,getEligibleForm:getEligibleForm,getEligibleBlock:getEligibleBlock,loadAnswers:loadAnswers,parseHash:parseHash}}]);