angular.module("vpApi.services",[]).service("$vpApi",["$rootScope","$http","config",function(e,o,n){var r=this,t=n.apiBaseUri;this.username="",this.user={},this.users,this.dbLoaded=!1,this.dbinit=function(e){return r.db=data.db,r.user=data.user,r.users=data.db.getCollection("user"),void(r.dbLoaded=!0)},this.getFormstack=function(){var e=null;try{e=r.db.getCollection("formstack").find({slug:r.user.profile.allowed_formstacks[0]})[0]}catch(o){console.log("[$vpApi.getFormstack()] Could not find formstack"),console.log(o)}return e},this.getTimestamp=function(){return(new Date).toISOString()},this.serialize=function(e){var o=[];for(var n in e)e.hasOwnProperty(n)&&o.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return o.join("&")},this.authenticate=function(n,s,c){console.log("[$vpApi.authenticate]");var i=t+"authenticate/",l={};o.post(i,n,l).success(function(o){var t=r.users.find({username:n.username});0===t.length?user=r.users.insert({username:n.username,token:o.token}):(user=t[0],user.token=o.token,user.username=n.username,r.users.update(user)),r.user=user,r.db.save(),localStorage.setItem("user",JSON.stringify(r.user)),console.log("broadcasting authenticated"),e.$broadcast("authenticated",{onSuccess:s})}).error(function(e,o){c(e,o)})},this.fetch=function(e,n,r,s){var c=t+e+"/",i=this.serialize(n);c+="?"+i;var l={headers:{Authorization:"Token "+this.user.token}};o.get(c,l).success(function(e,o){r(e,o)}).error(function(e,o){s(e,o)})},this.post=function(e,n,r,s){{var c=t+e+"/";({headers:{Authorization:"Token "+this.user.token}})}o({url:c,method:"POST",data:n,headers:{Authorization:"Token "+this.user.token}}).success(function(e,o){r(e,o)}).error(function(e,o){s(e,o)})},this.dbinit()}]).service("$user",["$rootScope","$vpApi","$formstack","$profile",function(e,o,n,r){e.$on("authenticated",function(e,t){r.fetch(function(){console.log("[$user] got profile"),o.db.save();try{var e=o.user.profile.allowed_formstacks[0]}catch(r){console.log("No allowed formstacks found.")}n.fetchBySlug(e,function(){console.log("[$user] succesfully fetched formstack"),o.db.save(),t.onSuccess()},function(e){console.log("[$user] failed to fetch formstack"),console.log(e)})},function(){console.log("Error fetching profile.")})})}]).service("$profile",["$http","$vpApi","config",function(e,o,n){var r=n.apiBaseUri;this.fetch=function(n,t){var s=r+"account/info/?user__username=",c=o.user.token,i={headers:{Authorization:"Token "+c}};console.log("[$profile.fetch()] About to fetch profile"),e.get(s+o.user.username,i).success(function(e){console.log("[$profile.fetch() callback] got data"),o.user.profile=e[0],o.users.update(o.user),n()}).error(function(){t()})}}]).service("$formstack",["$vpApi",function(e){var o=this;this.resource_name="pforms/formstack",this.formRepeatItem,this._fetchSuccess=function(n){o.objects=n,console.log("[$formstack.fetchSuccess] got data, now updating formstack collection");var r=e.db.getCollection("formstack"),t=r.find({slug:n[0].slug});t.length>0&&r.remove(t),r.insert(n[0])},this._fetchFail=function(e,n){console.log("Failed to fetch "+o.resource_name+". Returned Status: "+n),console.log(e)},this.fetchBySlug=function(n,r,t){HAS_CONNECTION&&(console.log("[$formstack.fetchBySlug] About to fetch formstack."),e.fetch(this.resource_name,{slug:n},function(t,s){o.objects=t,console.log("[$formstack.fetchBySlug] got data");var c=e.db.getCollection("formstack"),i=c.find({slug:n});i.length>0&&c.remove(i),c.insert(t[0]),r(t[0],s)},function(e,n){console.log("Failed to fetch "+o.resource_name+". Returned Status: "+n),console.log(e),t(e,n)}))},this.updateBySlug=function(n,r,t){console.log("[$formstack.fetchBySlug] About to fetch formstack.");var s={slug:n};e.fetch(this.resource_name,s,function(e,n){o._fetchSuccess(e,n),r(e[0])},function(e,n){o._fetchFail(e,n),t(e,n)})}}]).service("$fsResp",["$vpApi","$rootScope",function(e,o){var n=this;this.resource_name="pforms/formstack-response",o.$on("db_loaded",function(){console.log("$fsResp received db_loaded"),this.objects=e.db.getCollection("fsResp")}),this.delete=function(o){var r=n.objects.get(o);n.objects.remove(r);var t=e.db.getCollection("formResp").find({fsRespId:o}),s=e.db.getCollection("blockResp").find({fsRespId:o}),c=e.db.getCollection("answer").find({fsRespId:o});console.log("Deleting "+t.length+" form responses"),_.each(t,function(o){e.db.getCollection("formResp").remove(o)}),console.log("Deleting "+s.length+" block responses"),_.each(s,function(o){e.db.getCollection("blockResp").remove(o)}),console.log("Deleting "+c.length+" answers"),_.each(c,function(o){e.db.getCollection("answer").remove(o)}),e.db.save()}}]).service("$formResp",["$vpApi",function(){this.resource_name="pforms/form-response"}]).service("$blockResponse",["$formstack","$block","$rootScope","$answers","$formResponse",function(e,o,n){this.resource_name="pforms/block-response",n.$on("answer-created",function(){})}]).service("$answers",["$form","$rootScope","$filter","$vpApi","config",function(){this.resource_name="pforms/answer"}]).service("$mediacache",["$vpApi","$formstack","$http",function(e,o,n){var r=this;r.isCached=!1,this.run=function(){var o=r.getFilenames();_.each(o,function(o){n({method:"GET",withCredentials:!0,url:o}).success(function(n){var r=e.db.getCollection("media"),t=r.find({fname:o});t.length>0?(t.cupdate=e.getTimestamp(),r.update(t)):(t={fname:o,data:n,cupdate:e.getTimestamp()},r.insert(t)),e.db.save()}).error(function(){console.log("Could not load media file ")})})},this.getFilenames=function(){var o=e.getFormstack(),n=[];return _.each(o.forms,function(e){_.each(e.blocks,function(e){_.each(e.questions,function(e){e.options.geojsonChoices&&e.options.geojsonChoices.url&&(console.log("[getFilenames] found media file "+e.options.geojsonChoices.url),n.push(e.options.geojsonChoices.url))})})}),console.log("[getFilenames] File to cache: "),console.log(n),n}}]).service("$tilecache",["$vpApi","$formstack",function(e){var o=this;this.regions=[],this.isCached=function(){var e=localStorage.getItem("tilesCached"),o="true"===e?!0:!1;return o},this.getMaxCacheZoom=function(){var o=e.getFormstack(),n=_.find(o.forms,function(e){return"map-form"===e.options.type});return n?n.options.maxCacheZoom:null},this.getRegions=function(){console.log("[$tilecache.getRegions()] WTF"),out=[];var n=e.getFormstack();return _.each(n.forms,function(e){"map-form"===e.type&&e.options.regions&&(out=_.uniq(out.concat(e.options.regions))),console.log("[$tilecache.getRegions()] Found "+out.length+" regions")}),o.regions=out,out},this.getTileSources=function(){console.log("[$tilecache.getTileSources()] WTF"),out=[];var n=e.getFormstack();return _.each(n.forms,function(e){"map-form"===e.type&&e.options.tileSources&&(out=_.uniq(out.concat(e.options.tileSources))),console.log("[$tilecache.getTileSources()] Found "+out.length+" regions")}),o.tileSources=out,out},this.loadRegions=function(e,n){if(0===o.regions.length)return o.getRegions(),void(0===o.regions.length);var r=o.getMaxCacheZoom(),t=o.offlineLayer.calculateNbTiles(r,o.regions);1e4>t?(console.log("Will be saving: "+t+" tiles"),o.offlineLayer.saveRegions(o.regions,r,function(){console.log("[saveRegions] onStarted")},function(){console.log("[saveRegions] onSuccess"),localStorage.setItem("tilesCached","true"),e()},function(e){console.log("onError"),console.log(e),n()})):alert("You are trying to save "+t+" tiles. There is currently a limit of 10,000 tiles.")},this.run=function(e,n){console.log("[$tilecache.run()]");var r=o.getTileSources()[0];onError=function(e,o,r){console.log("[$tilecache.run.onError()] "),localStorage.setItem("tilesCached","false"),console.log(e),console.log(o),console.log(r),n()};var t=L.map("cache-map").setView([-2.9,-79],13),s={map:t,maxZoom:12,attribution:r.attrib,dbOnly:!0,onReady:function(){console.log("onReady for what?")},onError:function(){console.log("onError for what?")},storeName:r.storeName,dbOption:"WebSQL"};o.offlineLayer=new OfflineLayer(r.url,s),o.loadRegions(e,n)},clearTiles=function(){console.log("clearing tiles..."),o.offlineLayer.clearTiles(function(){console.log("[clearTiles] success")},function(){console.log("[clearTiles] fail")})}}]),angular.module("survey.services",[]).factory("$formUtils",["$vpApi","$location",function($vpApi,$location){var obj=this;return setState=function(e,o,n){if(e.current={fsResp:null,form:null,formIndex:null,formResp:null,block:null,blockIndex:null,blockResp:null,qIndex:null},e.formstack=$vpApi.getFormstack(),e.fsResps=$vpApi.db.getCollection("fsResp"),e.formResps=$vpApi.db.getCollection("formResp"),e.blockResps=$vpApi.db.getCollection("blockResp"),e.answers=$vpApi.db.getCollection("answer"),e.medias=$vpApi.db.getCollection("media"),e.forEach=[],"new"===n.fsRespId?(e.current.form=e.formstack.forms[0],e.current.formIndex=0,e.current.block=e.formstack.forms[0].blocks[0],e.current.blockIndex=0):(e.current.fsResp=e.fsResps.get(parseInt(n.fsRespId,10)),e.current.fsResp||console.error("Could not find Formstack Response: "+n.formRespId)),"app.map-form-foreach"===o.current.name||"app.map-form"===o.current.name){if(console.log("[setState] setting map-from-foreach specific variables here"),e.repeatCount=0,0===$location.hash().length&&$location.hash("intro"),e.hash=$location.hash(),e.medias=$vpApi.db.getCollection("media"),n.formRespId="new",e.selectedFeatures={"type:":"FeatureCollection",features:[]},e.current.form=_.find(e.formstack.forms,function(e){return e.id===parseInt(n.formId,10)}),e.current.block=e.current.form.blocks[0],n.qIndex=n.qIndex||"intro",e.current.formRepeatItem,e.current.formResp&&e.current.formResp.formRepeatItem&&(e.current.formRepeatItem=e.current.formResp.formRepeatItem),e.current.formIndex=_.indexOf(e.formstack.forms,e.current.form),e.current.blockIndex=_.indexOf(e.current.form.blocks,e.current.block),e.current.form.options.forEach&&e.current.form.options.forEach.length>0);else if(e.current.form.options.forEachAnswer&&e.current.form.options.forEachAnswer.length>0){var r=_getAnswer(e,e.current.form.options.forEachAnswer,e.current.fsRespId);e.forEach=[],_.each(r.value,function(o){e.forEach.push({verbose:o,value:o})})}else e.forEach=[{verbose:"",value:"default"}];e.mapQuestion=e.current.block.questions[0],_.each(e.current.block.questions,function(e){e.form={show:!1}})}else{if("new"===n.formRespId.split("-")[0]){var t=n.formRespId.split("-");if(2===t.length){var s=parseInt(t[1],10);e.current.form=_.find(e.formstack.forms,function(e){return e.id===s}),e.current.formIndex=_.indexOf(e.formstack.forms,e.current.form)}else{var s=null;e.current.form=e.formstack.forms[0],e.current.formIndex=0}}else n.formRespId.length<1&&console.error("No formRespId found in the URL"),e.current.formResp=e.formResps.get(parseInt(n.formRespId,10)),e.current.formIndex=e.current.formResp.formIndex,e.current.form=e.formstack.forms[e.current.formIndex];if("new"===n.blockRespId.split("-")[0]){var t=n.blockRespId.split("-");if(2===t.length){var c=parseInt(t[1],10);e.current.block=_.find(e.current.form.blocks,function(e){return e.id===c}),e.current.blockIndex=_.indexOf(e.current.form.blocks,e.current.block)}else e.current.block=e.current.form.blocks[0],e.current.blockIndex=0}else n.blockRespId.length<1&&console.error("No blockRespId found in the URL"),e.current.blockResp=e.blockResps.get(parseInt(n.blockRespId,10)),e.current.blockIndex=e.current.blockResp.blockIndex,e.current.block=e.current.form.blocks[e.current.blockIndex];if(e.current.block.options.forEachAnswer&&e.current.block.options.forEachAnswer.length>0){var r=_getAnswer(e,e.current.block.options.forEachAnswer,e.current.fsRespId);e.forEach=[],_.each(r.value,function(o){e.forEach.push({verbose:o,value:o})})}}},_getAnswer=function(e,o,n){n=n||e.current.fsResp.$loki,answers=$vpApi.db.getCollection("answer");var r=$vpApi.db.getCollection("answer").chain().find({questionSlug:o}).find({fsRespId:n}).data();return r.length>1?(console.log("found more than one answer, returns the first one."),console.table(r),r=r[0]):r=1===r.length?r[0]:null,console.log("Found answer: "+r),r},getEligibleBlock=function(direction,form,currentBlockIndex){function findEligibleBlock(direction){return console.log("[findEligibleNextBlock] looking for blockIndex "+currentBlockIndex),block="forward"===direction?blocks[currentBlockIndex+1]:blocks[currentBlockIndex-1],block?"undefined"!=typeof block.options.skipWhen&&(rs=eval(block.options.skipWhen),console.log("answer "),console.log(getAnswer("marine-activities")),rs?(console.log("[_getNextBlock()] I need to skip this block and get the next one"),"forward"===direction?currentBlockIndex++:currentBlockIndex--,findEligibleBlock(direction)):console.log("[_getNextBlock()] I can use this block.")):console.log("[_getNextBlock] there are no more blocks on this form"),block}var out,block,rs,blocks=form.blocks;return block=findEligibleBlock(direction)},getEligibleForm=function(direction,currentFormIndex){function findEligibleForm(direction){return console.log("[findNextEligibleForm] looking for formIndex "+currentFormIndex),form="forward"===direction?forms[currentFormIndex+1]:forms[currentFormIndex-1],form?"undefined"!=typeof form.options.skipWhen&&(rs=eval(form.options.skipWhen),rs?(console.log("[_findNextEligibleForm()] I need to skip this form and get the next one"),"forward"===direction?currentFormIndex++:currentFormIndex--,findEligibleForm(direction)):console.log("[_findNextEligibleForm()] I can use this form.")):console.log("[_getNextBlock] there are no more forms on this form"),form}var forms=$vpApi.getFormstack().forms;return form=findEligibleForm(direction)},loadAnswers=function(e,o,n,r){console.log("[$formUtils.loadAnswers()]");var t=!1;n+="",r+="",("new"===o||"new"===n.split("-")[0]||"new"===r.split("-")[0])&&(t=!0),e.previousAnswers=t?[]:e.answers.chain().find({fsRespId:parseInt(o,10)}).find({formRespId:parseInt(n,10)}).find({blockRespId:parseInt(r,10)}).data(),_.each(e.current.block.questions,function(o){var n=_.find(e.previousAnswers,function(e){return e.questionId===o.id});console.log("[loadAnswers] Question: "+o.slug),n?(o.value=n.value,o.previousValue=n.value,o.answerCid=n.$loki):"undefined"!=typeof o.options["default"]?(o.value=o.options["default"],o.previousValue=o.options["default"],o.answerCid=null):(o.value="",o.previousValue="",o.answerCid=null)})},parseHash=function(e){var o;if("intro"===e||"end"===e)return e;var n=e.split("/");return 3===n.length?(formRespId=n[0],blockRespId=n[1],qIndex=parseInt(n[2]),o=[formRespId,blockRespId,qIndex]):o=e,o},{setState:setState,getAnswer:_getAnswer,getEligibleForm:getEligibleForm,getEligibleBlock:getEligibleBlock,loadAnswers:loadAnswers,parseHash:parseHash}}]);