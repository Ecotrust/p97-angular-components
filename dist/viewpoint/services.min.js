angular.module("vpApi.services",[]).factory("$vpApi",["$http",function(e){function t(t,o,n){console.log("I should log in");var c=r+"authenticate/";s.username=t.username;var i={Authorization:"Token "+s.token};e.post(c,t,i).success(function(e,t){s.token=e.token,localStorage.setItem("token",e.token),o(e,t)}).error(function(e,t){n(e,t)})}function o(t,o,n,c){var i=r+t+"/",u={headers:{Authorization:"Token "+s.token}};e.get(i,u).success(function(e,t){n(e,t)}).error(function(e,t){c(e,t)})}function n(t,o,n,c){{var i=r+t+"/";({headers:{Authorization:"Token "+s.token}})}e({url:i,method:"POST",data:o,headers:{Authorization:"Token "+s.token}}).success(function(e,t){n(e,t)}).error(function(e,t){c(e,t)})}var s={username:null,token:null,profile:null};localStorage.getItem("token")&&(s.token=localStorage.getItem("token"));var r=API_BASE;return{apiBase:r,authenticate:t,user:s,fetch:o,post:n}}]).service("$formstack",["$vpApi","$localStorage",function(e,t){var o=this;this.resource_name="pforms/formstack",this.objects=[],this.loadBySlug=function(n,s,r){if(HAS_CONNECTION)e.fetch(this.resource_name,{slug:n},function(e,n){o.objects=e,console.log("[loadBySlug] got data"),t.setObject("formstack",e[0]),s(e[0],n)},function(e,t){console.log("Failed to fetch "+o.resource_name+". Returned Status: "+t),console.log(e),r(e,t)});else{var c=t.getObject("formstack");o.objects.push(c),s(c,null)}},this.getBySlug=function(e,t){return res=_.find(this.objects,function(o){return o[e]===t}),res||[]},this.fetchUpdates=function(e,t,o){console.log("[fetchUpdates] getting data"),this.loadBySlug(e,t,o)},this.getFormBySlug=function(e){var t=_.find(this.objects[0].forms,function(t){return t.slug===e});return t||[]},this.getBlocks=function(){return out=[],_.each(this.objects[0].forms,function(e){out=out.concat(e.blocks)}),out}}]).service("$form",["$formstack",function(e){this.getById=function(t){return res=_.find(e.objects[0].forms,function(e){return e.id===t})}}]).service("$block",["$formstack","$answers",function(e,t){this.newItemIndex=function(e){var o=_.filter(t.objects,function(t){return t.block===e.id}),n=0;if(o.length>0){var s=_.map(o,function(e){return e.blockResponse});s=_.unique(s),n=s.length}return n}}]).service("$formResponse",["$localStorage","$formstack","$rootScope","$answers",function(e,t,o,n){var s=this;this.resource_name="pforms/response",this.objects=[],this.load=function(){var t=e.getObject("formResponses");this.objects=t.objects||[]},this.getOrCreate=function(t,o){var n=_.find(s.objects,function(e){return e.cid===o});if(!n){var r=o,c=(new Date).toISOString();n={formSlug:t,cid:r,cupdate:c},this.objects.push(n),e.setObject("formResponses",this.objects)}return n},o.$on("answer-created",function(e,t){s.getOrCreate(t.formSlug,t.formResponse)}),this.getByFormSlug=function(e){var t=_.filter(s.objects,function(t){return t.formSlug===e});return t||[]},this.getByCid=function(e){return _.find(s.objects,function(t){return t.cid===e})},this.getBlockResponses=function(){var e=[],o=t.getBlocks();return _.each(o,function(t){var o=n.getByBlockId(t.id),s=_.map(o,function(e){return e.blockResponse});s=_.unique(s),e.push({block:t.id,blockResponses:s})}),e}}]).service("$blockResponse",["$localStorage","$formstack","$block","$rootScope","$answers","$formResponse",function(e,t,o,n,s,r){var c=this;this.objects=[],this.load=function(){var t=e.getObject("blockResponses");this.objects=t.objects||[]},this.getOrCreate=function(t,o,n){var s=_.find(c.objects,function(e){return e.cid===n.blockResponse});if(!s){var r=n.blockResponse,i=(new Date).toISOString();s={block:n.block,blockName:n.blockName,formSlug:t,formResponse:o,cid:r,cupdate:i},this.objects.push(s),e.setObject("blockResponses",this.objects)}return s},n.$on("answer-created",function(e,t){c.getOrCreate(t.formSlug,t.formResponse,t)}),this.getResponseIndex=function(e){if("new-block"===e)return-1;var t=_.find(c.objects,function(t){return t.cid===e});return responses=this.getByFormAndBlock(t.formResponse,t.block),t?out=_.indexOf(responses,t):void 0},this.getByFormResponse=function(e){var t=_.filter(c.objects,function(t){return t.formResponse===e});return t},this.getByFormAndBlock=function(e,t){var o;o="number"==typeof t?t:t.id;var n=_.filter(c.objects,function(t){return t.block===o&&t.formResponse===e});return n},this.prev=function(e){var t=null,o=_.find(c.objects,function(t){return t.cid===e});if(o){var n=_.indexOf(c.objects,o);n>0&&(t=c.objects[n-1].cid)}return t},this.next=function(e){var t=null,o=_.find(c.objects,function(t){return t.cid===e});if(o){var n=_.indexOf(c.objects,o);n<c.objects.length-1&&(t=c.objects[n+1].cid)}return t},this.getByBlockIndex=function(e,o){var n=[],s=r.getByCid(e);if(s){var i=t.getFormBySlug(s.formSlug),u=i.blocks[o];u&&(res=_.filter(c.objects,function(e){return e.block===u.id&&e.formResponse===s.cid})),n=res}return n}}]).service("$answers",["$localStorage","$form","$rootScope","$filter","$vpApi","config",function(e,t,o,n,s,r){var c=this;this.objects=[],this.resource_name="pforms/answer",this.load=function(){var t=e.getObject("answers");this.objects=t.objects||[]},this.fetchUpdates=function(t){data={response__formstack:r.formstackSlug,response__owner__username:s.username},s.fetch(this.resource_name,data,function(o,s){_.each(o,function(e){e.cid||(e.cid="answer_"+n("date")(Date.now(),"yyyyMMddhhmmss.sss"))}),c.objects=o,e.setObject("answers",o),t(o,s)},function(e,t){console.log("Failed to fetch "+c.resource_name+". Returned Status: "+t),console.log(e)})},this.getByCid=function(e){return answer=_.find(this.objects,function(t){return t.cid===e})},this.getByBlockId=function(e,t){var o,n=_.filter(this.objects,function(n){return o=t?n.block===e&&n.blockResponse===t:n.block===e});return n},this.getByFormId=function(e){{var o=[];t.getById(e)}return o=_.filter(this.objects,function(t){return t.form===e})},this.create=function(t,s,r,c,i,u){var a="answer_"+n("date")(Date.now(),"yyyyMMddhhmmss.sss"),f=(new Date).toISOString();item={form:t.id,formSlug:t.slug,formResponse:s,block:r.id,blockName:r.name,blockResponse:c,question:i.id,questionSlug:i.slug,data:{value:u},cid:a,cupdate:f},this.objects.push(item),e.setObject("answers",this.objects),o.$broadcast("answer-created",item)},this.update=function(t,o){answer=this.getByCid(t);var n=_.indexOf(this.objects,answer);this.objects[n].data={value:o},this.objects[n].cupdate=(new Date).toISOString(),console.log("[$answer.update()] updating answer"),console.log(this.objects[n]),e.setObject("answers",this.objects)}}]).service("$profile",["$http","$vpApi",function(e,t){var o=API_BASE,n=t.user;localStorage.getItem("profile")&&(n.profile=JSON.parse(localStorage.getItem("profile")),t.user.profile=n.profile),this.load=function(s){var r=o+"account/profile/?user__username=",c={headers:{Authorization:"Token "+n.token}};e.get(r+n.username,c).success(function(e){console.log("[loadProfile] got data"),t.user.profile=e[0],console.log(e[0]),localStorage.setItem("profile",JSON.stringify(e[0])),"function"==typeof s&&s()})},this.update=function(){}}]).factory("Question",["$vpApi",function(e){function t(t){e.fetch(r,{},function(e,o){c=e,t(e,o)},function(e,t){console.log("Failed to fetch "+r+". Returned Status: "+t),console.log(e)})}function o(t,o){e.post(r,t,function(e,t){o(e,t)},function(e,t){console.log("Failed to create "+r+". Returned Status: "+t),console.log(e),o(e,t)})}function n(e,t){return res=_.find(c,function(o){return o[e]===t}),res||[]}function s(e){return e.options={placeholder:""},e.type=parseInt(e.type),e}var r="pforms/question",c=[];return{load:t,create:o,get:n,objects:c,cleanData:s}}]).factory("$localStorage",["$window",function(e){return{set:function(t,o){e.localStorage[t]=o},get:function(t,o){return e.localStorage[t]||o},setObject:function(t,o){e.localStorage[t]=JSON.stringify(o)},getObject:function(t){return JSON.parse(e.localStorage[t]||"{}")}}}]);