angular.module("vpApi.services",[]).service("$vpApi",["$rootScope","$http","config",function(e,o,t){var s=this,n=t.apiBaseUri;this.username="",this.user={},this.users,this.dbinit=function(){this.db=new loki(t.dbFilename);var e=localStorage.getItem(t.dbFilename);e?this.db.loadJSON(e):(console.log("[$vpApi] Database not found"),console.log("[$vpApi] creating database "+t.dbFilename),s._createDb()),this.users=this.db.getCollection("user"),this.users.data.length>0&&this.users.data[0].username&&(this.user=this.users.data[0])},this._createDb=function(){s.db.addCollection("user"),s.db.addCollection("formstack"),s.db.addCollection("fsResp"),s.db.addCollection("formResp"),s.db.addCollection("blockResp"),s.db.addCollection("answer"),s.db.save()},this.getFormstack=function(){var e=null;try{e=s.db.getCollection("formstack").find({slug:s.user.profile.allowed_formstacks[0]})[0]}catch(o){console.log("[$vpApi.getFormstack()] Could not find formstack"),console.log(o)}return e},this.getTimestamp=function(){return(new Date).toISOString()},this.authenticate=function(t,r,i){console.log("[$vpApi.authenticate]");var c=n+"authenticate/",l={};o.post(c,t,l).success(function(o){var n=s.users.find({username:t.username});0===n.length?n=s.users.insert({username:t.username,token:o.token}):(n[0].token=o.token,n[0].username=t.username,s.users.update(n[0])),s.user=n,s.db.save(),console.log("broadcasting authenticated"),e.$broadcast("authenticated",{onSuccess:r})}).error(function(e,o){i(e,o)})},this.fetch=function(e,t,s,r){var i=n+e+"/",c={headers:{Authorization:"Token "+this.user.token}};o.get(i,c).success(function(e,o){s(e,o)}).error(function(e,o){r(e,o)})},this.post=function(e,t,s,r){{var i=n+e+"/";({headers:{Authorization:"Token "+this.user.token}})}o({url:i,method:"POST",data:t,headers:{Authorization:"Token "+this.user.token}}).success(function(e,o){s(e,o)}).error(function(e,o){r(e,o)})},this.dbinit()}]).service("$user",["$rootScope","$vpApi","$formstack","$profile",function(e,o,t,s){e.$on("authenticated",function(e,n){s.fetch(function(){console.log("[$user] got profile"),o.db.save();try{var e=o.user.profile.allowed_formstacks[0]}catch(s){console.log("No allowed formstacks found.")}t.fetchBySlug(e,function(){console.log("[$user] succesfully fetched formstack"),o.db.save(),n.onSuccess()},function(e){console.log("[$user] failed to fetch formstack"),console.log(e)})},function(){console.log("Error fetching profile.")})})}]).service("$profile",["$http","$vpApi","config",function(e,o,t){var s=t.apiBaseUri;this.fetch=function(t,n){var r=s+"account/profile/?user__username=",i=o.user.token,c={headers:{Authorization:"Token "+i}};console.log("[$profile.fetch()] About to fetch profile"),e.get(r+o.user.username,c).success(function(e){console.log("[$profile.fetch() callback] got data"),o.user.profile=e[0],o.users.update(o.user),t()}).error(function(){n()})}}]).service("$formstack",["$vpApi",function(e){var o=this;this.resource_name="pforms/formstack",this.formRepeatItem,this.fetchBySlug=function(t,s,n){HAS_CONNECTION&&(console.log("[$formstack.fetchBySlug] About to fetch formstack."),e.fetch(this.resource_name,{slug:t},function(n,r){o.objects=n,console.log("[$formstack.fetchBySlug] got data");var i=e.db.getCollection("formstack"),c=i.find({slug:t});c.length>0&&i.remove(c),i.insert(n[0]),s(n[0],r)},function(e,t){console.log("Failed to fetch "+o.resource_name+". Returned Status: "+t),console.log(e),n(e,t)}))}}]).service("$fsResp",["$vpApi",function(e){var o=this;this.resource_name="pforms/formstack-response",this.objects=e.db.getCollection("fsResp"),this.objects.all=function(){return this.data},this.delete=function(t){var s=o.objects.get(t);o.objects.remove(s);var n=e.db.getCollection("formResp").find({fsRespId:t}),r=e.db.getCollection("blockResp").find({fsRespId:t}),i=e.db.getCollection("answer").find({fsRespId:t});console.log("Deleting "+n.length+" form responses"),_.each(n,function(o){e.db.getCollection("formResp").remove(o)}),console.log("Deleting "+r.length+" block responses"),_.each(r,function(o){e.db.getCollection("blockResp").remove(o)}),console.log("Deleting "+i.length+" answers"),_.each(i,function(o){e.db.getCollection("answer").remove(o)}),e.db.save()}}]).service("$formResp",["$vpApi",function(e){this.resource_name="pforms/form-response",this.objects=e.db.getCollection("formResp"),this.objects.all=function(){return this.data}}]).service("$blockResponse",["$formstack","$block","$rootScope","$answers","$formResponse",function(e,o,t){this.resource_name="pforms/block-response",t.$on("answer-created",function(){})}]).service("$answers",["$form","$rootScope","$filter","$vpApi","config",function(){this.resource_name="pforms/answer"}]).service("$tilecache",["$vpApi","$formstack",function(e){var o=this;this.regions=[],this.isCached=function(){var e=localStorage.getItem("tilesCached"),o="true"===e?!0:!1;return o},this.getMaxCacheZoom=function(){var o=e.getFormstack(),t=_.find(o.forms,function(e){return"map-form"===e.options.type});return t?t.options.maxCacheZoom:null},this.getRegions=function(){console.log("[$tilecache.getRegions()] WTF"),out=[];var t=e.getFormstack();return _.each(t.forms,function(e){"map-form"===e.type&&e.options.regions&&(out=_.uniq(out.concat(e.options.regions))),console.log("[$tilecache.getRegions()] Found "+out.length+" regions")}),o.regions=out,out},this.getTileSources=function(){console.log("[$tilecache.getTileSources()] WTF"),out=[];var t=e.getFormstack();return _.each(t.forms,function(e){"map-form"===e.type&&e.options.tileSources&&(out=_.uniq(out.concat(e.options.tileSources))),console.log("[$tilecache.getTileSources()] Found "+out.length+" regions")}),o.tileSources=out,out},this.loadRegions=function(e,t){if(0===o.regions.length)return o.getRegions(),void(0===o.regions.length);var s=o.getMaxCacheZoom(),n=o.offlineLayer.calculateNbTiles(s,o.regions);1e4>n?(console.log("Will be saving: "+n+" tiles"),o.offlineLayer.saveRegions(o.regions,s,function(){console.log("[saveRegions] onStarted")},function(){console.log("[saveRegions] onSuccess"),localStorage.setItem("tilesCached","true"),e()},function(e){console.log("onError"),console.log(e),t()})):alert("You are trying to save "+n+" tiles. There is currently a limit of 10,000 tiles.")},this.run=function(e,t){console.log("[$tilecache.run()]");var s=o.getTileSources()[0];onError=function(e,o,s){console.log("[$tilecache.run.onError()] "),localStorage.setItem("tilesCached","false"),console.log(e),console.log(o),console.log(s),t()};var n=L.map("cache-map").setView([-2.9,-79],13),r={map:n,maxZoom:12,attribution:s.attrib,dbOnly:!0,onReady:function(){console.log("onReady for what?")},onError:function(){console.log("onError for what?")},storeName:s.storeName,dbOption:"WebSQL"};o.offlineLayer=new OfflineLayer(s.url,r),o.loadRegions(e,t)},clearTiles=function(){console.log("clearing tiles..."),o.offlineLayer.clearTiles(function(){console.log("[clearTiles] success")},function(){console.log("[clearTiles] fail")})}}]);