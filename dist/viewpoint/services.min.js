angular.module("cache.services",[]).service("$mediacache",["$vpApi","$formstack","$http","$q",function(e,o,t,n){var r=this;r.isCached=!1,this.run=function(){if(USE_INDEXED_DB&&void 0!==e.user){var o=e.db.getCollection("media"),n=r.getFilenames();_.each(n,function(n){t({method:"GET",url:n}).success(function(t){var r=o.find({fname:n});r.length>0?(r.cupdate=e.getTimestamp(),o.update(r)):(r={fname:n,data:t,cupdate:e.getTimestamp()},o.insert(r)),e.db.save()}).error(function(){console.log("Could not load media file ")})}),org_id=e.user.profile.orgs[0].id,e.fetch("pforms/org-media",{org:org_id},function(t){_.each(t,function(t){if(t.imageName){var n=o.find({fname:t.imageName});n.length>0?(n.cupdate=e.getTimestamp(),n.data="data:image/jpeg;base64,"+t.image64,o.update(n)):(n={fname:t.imageName,data:"data:image/jpeg;base64,"+t.image64,cupdate:e.getTimestamp()},o.insert(n)),e.db.save()}})},function(){console.log("Failed to fetch org-media")})}},this.get=function(o){console.log("[mediacache.get]");var r=n.defer(),s=e.db.getCollection("media"),c=s.find({fname:o});if(c.length>0)console.log("[found entry]"),r.resolve(c[0],"");else{console.log("[fetching over web]");var i="mock/"+o;t.get(i).success(function(e){var t={fname:o,data:e};r.resolve(t,"")}).error(function(){console.log("[mediacache.get] Could not retrieve media file ")})}return r.promise},this.getFilenames=function(){var o=e.getApp(),t=[];return o&&o.formstacks&&_.each(o.formstacks,function(e){_.each(e.forms,function(e){_.each(e.blocks,function(e){_.each(e.questions,function(e){e.options.geojsonChoices&&e.options.geojsonChoices.path&&t.push(e.options.geojsonChoices.path),e.options.geoFence&&e.options.geoFence.path&&t.push(e.options.geoFence.path)})})})}),console.log("[getFilenames] Files to cache: "),console.log(t),t=_.uniq(t)}}]).service("$tilecache",["$vpApi","$formstack","$timeout",function(e,o,t){var n=this;this.regions=[],this.cacheTimer={start:null,stop:null,elasped:null},this.isCached=function(e){var o=parseInt(localStorage.getItem("tilesCount"));return o===e},this.getMaxCacheZoom=function(){var o,t=e.getFormstack(),n=_.find(t.forms,function(e){return"map-form"===e.type});return o=n?n.options.maxCacheZoom:null},this.getRegions=function(e){var o=[];return _.each(e.forms,function(e){"map-form"===e.type&&e.options.regions&&(o=_.uniq(o.concat(e.options.regions)))}),n.regions=o,o},this.getTileSources=function(e){n.tileSources=[];var o=_.find(e.forms,function(e){return"map-form"===e.type&&e.options.tileSources});return o&&(n.tileSources=o.options.tileSources),n.tileSources},this.loadRegions=function(e,o,t){if(0===n.regions.length)return n.getRegions(),void(0===n.regions.length);var r=n.getMaxCacheZoom(),s=e.calculateNbTiles(r,n.regions);console.log("Will be saving: "+s+" tiles"),e.saveRegions(n.regions,r,function(){console.log("[saveRegions] onStarted")},function(){console.log("[saveRegions] onSuccess"),n.cacheTimer.stop=new Date,n.cacheTimer.elasped=n.cacheTimer.stop-n.cacheTimer.start,console.log("Cache timer elapsed time (min): "+n.cacheTimer.elasped/1e3/60);var e=parseInt(localStorage.getItem("tilesCount"))||0;localStorage.setItem("tilesCount",e+1),o()},function(e){console.log("onError"),console.log(e),t()})},this.run=function(o,r){n.offlineLayers=[],n.cacheTimer.start=new Date;var s=e.getApp();_.each(s.formstacks,function(e){tileSources=n.getTileSources(e)}),onError=function(e,o,t){console.log("[$tilecache.run.onError()] "),localStorage.setItem("tilesCount",0),console.log(e),console.log(o),console.log(t),r()};var c=L.map("cache-map").setView([-2.9,-79],13);_.each(tileSources,function(e){var s={map:c,maxZoom:n.getMaxCacheZoom(),attribution:e.attrib,subdomains:e.subdomain,dbOnly:!0,onReady:function(){console.log("onReady for what?")},onError:function(){console.log("onError for what?")},storeName:e.storeName,dbOption:"IndexedDB"},i=new OfflineLayer(e.url,s);n.offlineLayers.push(i),t(function(){n.loadRegions(i,o,r)},1e3)})},this.clearTiles=function(){console.log("clearing tiles..."),n.offlineLayer.clearTiles(function(){console.log("[clearTiles] success")},function(){console.log("[clearTiles] fail")})},this.clearTilesDb=function(o){var t=e.getApp(),r=[];_.each(t.formstacks,function(e){r=n.getTileSources(e)}),osTableNames=[],_.each(r,function(e,o){osTableNames.push(e.storeName),dbName="IDBWrapper-"+osTableNames[o];var t=window.indexedDB.open(dbName,1);t.onerror=function(e){console.log("[openTilesDb] Database error: "+e.target.errorCode)},t.onsuccess=function(){window.db=t.result,console.log("[openTilesDb] Opened "+window.db.name+" with dataStores"),console.log(window.db.objectStoreNames);var e=window.db.name.split("-")[1],o=window.db.transaction(e,"readwrite").objectStore(e);o.clear().onsuccess=function(){localStorage.removeItem("tilesCount"),console.log("Finished clearing "+e)}}}),o(event)}}]),angular.module("dock.services",[]).service("$choiceList",["$vpApi","$formstack","$http","$q",function(e,o,t,n){var r=this;r.species=[],r.sites=[],r.fetch=function(o){var t=n.defer(),s=e.user.profile.orgs[0].slug,c={orgSlug:s};return e.fetch("dock/"+o,c,function(e,n){r[o]=e,t.resolve(e,n)},function(e,o){console.log("[choiceList.fetch] failed",e),t.reject(e,o)}),t.promise},r.save=function(o,t){var r=n.defer(),s=e.user.profile.orgs[0].id;t[s]=s;var c="post",i="dock/"+o;return void 0!==t.id&&(c="patch",i+="/"+t.id),e[c](i,t,function(e,o){r.resolve(e,o)},function(e,o){console.log("[choiceList.save] failed",e),r.reject(e,o)}),r.promise}}]).service("$qaRecord",["$vpApi","$q",function(e,o){var t=this,n="dock/qa-record";t.fetch=function(){var t=o.defer(),r=e.user.profile.orgs[0].slug,s={orgSlug:r};return e.fetch(n,s,function(e,o){t.resolve(e,o)},function(e,o){console.log("[choiceList.fetch] failed",e),t.reject(e,o)}),t.promise},t.fetchById=function(t){var r=o.defer(),s=e.user.profile.orgs[0].slug,c={orgSlug:s,full:!0};return e.fetch(n+"/"+t,c,function(e,o){r.resolve(e,o)},function(e,o){console.log("[$qaRecord.fetchById] failed",e),r.reject(e,o)}),r.promise}}]).service("$combinedSample",["$vpApi","$q",function(e,o){var t=this,n="dock/combined-sample";t.fetchByQaRecordId=function(t){var r=o.defer(),s=(e.user.profile.orgs[0].slug,{qarecordId:t});return e.fetch(n,s,function(e,o){e=e.length>0?e[0]:null,r.resolve(e,o)},function(e,o){console.log("[$combinedSample.fetchById] failed",e),r.reject(e,o)}),r.promise}}]).service("$sample",["$vpApi","$q",function(e,o){var t=this,n="dock/qa-record";t.fetch=function(){var t=o.defer(),r=e.user.profile.orgs[0].slug,s={orgSlug:r};return e.fetch(n,s,function(e,o){t.resolve(e,o)},function(e,o){console.log("[choiceList.fetch] failed",e),t.reject(e,o)}),t.promise},t.fetchById=function(t){var r=o.defer(),s=e.user.profile.orgs[0].slug,c={orgSlug:s,full:!0};return e.fetch(n+"/"+t,c,function(e,o){r.resolve(e,o)},function(e,o){console.log("[$qaRecord.fetchById] failed",e),r.reject(e,o)}),r.promise}}]).service("$dockUser",["$vpApi","$q",function(e,o){this.save=function(t){var n,r=o.defer(),s="dock/user";return void 0===t.id?n="post":(n="patch",s=s+"/"+t.id),e[n](s,t,function(e,o){r.resolve(e,o)},function(e,o){r.reject(e,o)}),r.promise}}]).service("$surveyor",["$vpApi","$q",function(e,o){this.save=function(t){var n,r=o.defer(),s="dock/surveyor";return void 0===t.id?n="post":(n="patch",s=s+"/"+t.id),e[n](s,t,function(e,o){r.resolve(e,o)},function(e,o){r.reject(e,o)}),r.promise}}]),angular.module("mock-ionic.services",[]).service("$ionicLoading",["blockUI","$timeout",function(e,o){console.log("mock $ionicLoading "),obj=this;var t=e.instances.get("myBlockUI");this.show=function(){"web"===platform&&(t.reset(),t.start())},this.hide=function(){"web"===platform&&o(function(){t.stop()},2e3)}}]).service("$loadingModal",["$modal",function(e){var o=this;o.$modal=e({template:"views/partials/loading-modal.html",container:"body",backdrop:"static",placement:"center",keyboard:!1,show:!1}),o.show=function(){o.$modal.$promise.then(function(){o.$modal.show()})},o.hide=function(){o.$modal.hide()}}]).service("$ionicModal",["$q",function(e){console.log("mock $ionicModal"),this.fromTemplateUrl=function(){return e(function(e){e("Fake resolve")})}}]).service("$ionicPopup",["$q",function(e){console.log("mock $ionicPopup"),this.confirm=function(){return e(function(e){e("Fake resolve")})}}]).service("$ionicScrollDelegate",[function(){console.log("mock $ionicScrollDelegate")}]),angular.module("ionic-timepicker",[],function(){}),angular.module("survey.services",[]).factory("$formUtils",["$vpApi","$location","$formstack","$formResp",function($vpApi,$location,$formstack,$formResp){var obj=this,VERBOSE=!1;return setState=function(e,o,t){e.current={fsResp:null,form:null,formIndex:null,formResp:null,block:null,blockIndex:null,blockResp:null,qIndex:null,hash:null},e.current.formRepeatItem;var n=null;if(t&&t.fsSlug&&(n=t.fsSlug),e.formstack=$vpApi.getFormstack(n),e.fsResps=$vpApi.db.getCollection("fsResp"),e.formResps=$vpApi.db.getCollection("formResp"),e.blockResps=$vpApi.db.getCollection("blockResp"),e.answers=$vpApi.db.getCollection("answer"),e.medias=$vpApi.db.getCollection("media"),"new"===t.fsRespId?(e.current.form=angular.copy(e.formstack.forms[0]),e.current.formIndex=0,e.current.block=angular.copy(e.formstack.forms[0].blocks[0]),e.current.blockIndex=0):(e.current.fsResp=e.fsResps.find({id:t.fsRespId})[0],e.current.fsResp||console.error("Could not find Formstack Response: "+t.formRespId)),"app.map-form-foreach"===o.current.name||"app.map-form"===o.current.name)if(e.repeatCount=0,$location.hash("intro"),e.current.hash=$location.hash(),t.formRespId="new",e.selectedFeatures={"type:":"FeatureCollection",features:[]},e.current.form=_.find(e.formstack.forms,function(e){return e.id===parseInt(t.formId,10)}),e.current.block=e.current.form.blocks[0],e.mapQuestion=e.current.block.questions[0],e.mapQuestion.value="",_.each(e.current.block.questions,function(e){e.form={show:!1}}),t.qIndex=t.qIndex||"intro",e.current.formResp&&e.current.formResp.formForEachItem&&(e.current.formRepeatItem=e.current.formResp.formForEachItem),e.current.formIndex=_.indexOf(e.formstack.forms,e.current.form),e.current.blockIndex=_.indexOf(e.current.form.blocks,e.current.block),e.current.form.options.forEach&&e.current.form.options.forEach.length>0);else if(e.current.form.options.forEachAnswer&&e.current.form.options.forEachAnswer.length>0){var r=_getAnswer(e,e.current.form.options.forEachAnswer,e.current.fsRespId);e.forEach=[],_.each(r.value,function(o){e.forEach.push({verbose:o,value:o})})}else if(e.current.form.blocks[0].options.repeatable){var s=e.formResps.chain().find({fsRespId:e.current.fsResp.id}).find({formId:e.current.form.id}).data();0===s.length?(e.current.formResp=e.formResps.insert({fsSlug:e.formstack.slug,fsRespId:e.current.fsResp.id,formId:e.current.form.id,formIndex:e.current.formIndex,formForEachItem:null,client_created:$vpApi.getTimestamp(),client_updated:$vpApi.getTimestamp()}),$vpApi.db.save()):e.current.formResp=s[0],e.current.form.blockResps=e.blockResps.chain().find({fsRespId:e.current.fsResp.id}).find({formId:e.current.form.id}).data()}else{var s=e.formResps.chain().find({fsRespId:e.current.fsResp.id}).find({formId:e.current.form.id}).data();0===s.length?(e.current.formResp=e.formResps.insert({fsSlug:e.formstack.slug,fsRespId:e.current.fsResp.id,formId:e.current.form.id,formIndex:e.current.formIndex,formForEachItem:null,client_updated:$vpApi.getTimestamp()}),$vpApi.db.save()):e.current.formResp=s[0];var c=e.blockResps.chain().find({fsRespId:e.current.fsResp.id}).find({formRespId:e.current.formResp.id}).find({blockId:e.current.block.id}).data();c.length>0&&(e.current.blockResp=c[0])}else if("app.form-foreach"===o.current.name)e.current.form=_.find(e.formstack.forms,function(e){return e.id===t.formId}),e.current.formIndex=_.indexOf(e.formstack.forms,e.current.form),e.current.page=t.page,e.current.form.forEach=null;else{if("new"===t.formRespId.split("-")[0]){var i=t.formRespId.split("-");if(2===i.length){var a=parseInt(i[1],10);e.current.form=_.find(e.formstack.forms,function(e){return e.id===a}),e.current.formIndex=_.indexOf(e.formstack.forms,e.current.form)}else{var a=null;e.current.form=e.formstack.forms[0],e.current.formIndex=0}}else t.formRespId.length<1&&console.error("No formRespId found in the URL"),e.current.formResp=e.formResps.find({id:t.formRespId})[0],e.current.formIndex=e.current.formResp.formIndex,e.current.form=e.formstack.forms[e.current.formIndex];if("new"===t.blockRespId.split("-")[0]){var i=t.blockRespId.split("-");if(2===i.length){var l=parseInt(i[1],10);e.current.block=_.find(e.current.form.blocks,function(e){return e.id===l}),e.current.blockIndex=_.indexOf(e.current.form.blocks,e.current.block)}else e.current.block=e.current.form.blocks[0],e.current.blockIndex=0}else t.blockRespId.length<1&&console.error("No blockRespId found in the URL"),e.current.blockResp=e.blockResps.find({id:t.blockRespId})[0],e.current.blockIndex=e.current.blockResp.blockIndex,e.current.block=e.current.form.blocks[e.current.blockIndex]}if(e.current.form.options.forEach&&e.current.form.options.forEach.length>0);else if(e.current.form.options.forEachAnswer&&e.current.form.options.forEachAnswer.length>0){var f,r=_getAnswer(e,e.current.form.options.forEachAnswer,e.current.fsRespId);e.current.form.forEach=[],_.each(r.value,function(o){f=$formstack.getChoice(e.current.form.options.forEachAnswer,o),e.current.form.forEach.push(f)})}if(e.current.form.forEach&&loadFormForEachItems(e),e.current.block)if(e.current.block.options.forEach&&e.current.block.options.forEach.length>0);else if(e.current.block.options.forEachAnswer&&e.current.block.options.forEachAnswer.length>0){var r=_getAnswer(e,e.current.block.options.forEachAnswer,e.current.fsRespId);e.current.block.forEach=[],_.each(r.value,function(o){e.current.block.forEach.push({verbose:o,value:o})})}var u=null;if(e.current.formResp&&void 0!==e.current.formResp.formForEachItem){var u=e.current.formResp.formForEachItem;(null===u||""===u)&&(u=null)}null!==u&&(f=$formstack.getChoice(e.current.formResp.formForEachQuestionSlug,e.current.formResp.formForEachItem),e.current.form.formForEachItem=f)},changeState=function(e,o,t){{var n,r,s,c,i,a="app.",l=null,f=null;e.current.form.blocks}if(o&&o.params&&o.params.fsSlug&&(f=o.params.fsSlug),getAnswer=function(o){fsRespId=e.current.fsResp.id,answers=$vpApi.db.getCollection("answer");var t=$vpApi.db.getCollection("answer").chain().find({questionSlug:o}).find({fsRespId:fsRespId}).data();return t.length>1?(console.warn("[getAnswer()] found more than one answer, returns the first one."),console.table(t),t=t[0]):1===t.length?t=t[0]:(t=null,console.error("[]getAnswer] No answer found")),VERBOSE&&console.log("Found answer: "+t),t},"forward"===t||"repeat-block"===t||"repeat-form"===t){if("forward"===t?r="end"===e.current.page||"intro"===e.current.page?null:this.getEligibleBlock(t,e.current.form,e.current.blockIndex):("repeat-block"===t||"repeat-form"===t)&&(r=e.current.block),r){VERBOSE&&console.log("[LinearBlockCtrl.saveBlock()] found next block, setting state");var u,d;if("forward"===t){formRespId=e.current.formResp.id;var p=e.blockResps.chain().find({blockId:r.id}).find({formRespId:e.current.formResp.id}).data();u=p.length>0?p.slice(-1)[0].id:"new-"+r.id}else if("repeat-form"===t){if("map-form"===e.current.form.type)return void $location.hash("intro");formRespId="new-"+e.current.form.id,u="new-"+r.id}else if("repeat-block"===t){if("map-form"===e.current.form.type){var u="new-"+e.current.block.id;return void $location.hash([e.current.formResp.id,u,0].join("/"))}formRespId=e.current.formResp.blockRespId="new-"+r.id,l="0"}return a+=e.current.form.type?e.current.form.type:"form",e.current.form.forEach&&_.indexOf(e.current.form.blocks,r)===e.current.form.blocks.length-1&&(a+="-foreach",d="end"),n={fsSlug:e.formstack.slug,fsRespId:e.current.fsResp.id,formRespId:formRespId,formId:e.current.form.id,blockRespId:u,hash:l,page:d,qIndex:l},void o.go(a,n)}VERBOSE&&console.log("[LinearBlockCtrl.saveBlock()] No more blocks in this form, so grabbing the first block of the next form");var m,r,g,s=this.getEligibleForm(t,e.current.formIndex,f);return s?(a+=s.type?s.type:"form",formResps=e.formResps.chain().find({fsRespId:e.current.fsResp.id}).find({formId:s.id}).simplesort("created").data(),m=formResps.length>0?formResps[0].id:"new-"+s.id,r=getEligibleBlock("forward",s,-1),r.forEach?console.error("Not implemented"):(p=e.blockResps.chain().find({fsRespId:e.current.fsResp.id}).find({formRespId:m}).find({blockId:r.id}).simplesort("$loki",!1).data(),g=p.length>0?p[0].id:"new-"+r.id),(s.options.forEach||s.options.forEachAnswer)&&(a+="-foreach",l="intro"),n={fsSlug:e.formstack.slug,fsRespId:e.current.fsResp.id,formId:s.id,formRespId:m,blockRespId:g,hash:l,page:l,qIndex:"intro"},void o.go(a,n)):(VERBOSE&&console.log("[LinearBlockCtrl.saveBlock()] No more forms. You are done."),e.current.fsResp.status="complete",e.current.fsResp.client_updated=$vpApi.getTimestamp(),$vpApi.db.save(),VERBOSE&&console.log("[LinearBlockCtrl.saveBlock()] No more forms. You are done."),void o.go("app.complete",{fsRespId:e.current.fsResp.id}))}if("back"===t)if(v=this.getEligibleBlock(t,e.current.form,e.current.blockIndex)){VERBOSE&&console.log("[LinearBlockCtrl.saveBlock()] found next block");var h=e.blockResps.chain().find({blockId:v.id}).find({formRespId:e.current.formResp.id}).data();i=h.length>0?h.slice(-1)[0]:{id:"new-"+v.id},a+=e.current.form.type?e.current.form.type:"form",n={fsSlug:e.formstack.slug,fsRespId:e.current.fsResp.id,formRespId:e.current.formResp.id,blockRespId:i.id,hash:l}}else{if(VERBOSE&&console.log("[LinearBlockCtrl.saveBlock()] This is the first block in the form"),prevForm=this.getEligibleForm(t,e.current.formIndex,f),!prevForm)return VERBOSE&&console.log("[LinearBlockCtrl.saveBlock()] No more forms. You are done."),void o.go("app.home");VERBOSE&&console.log("[LinearBlockCtrl.saveBlock()] Found prev form");var c=e.formResps.chain().find({fsRespId:e.current.fsResp.id}).find({formId:prevForm.id}).data();c=c.length>1?c.slice(-1)[0]:1===c.length?c[0]:{id:"new-"+prevForm.id};var v=this.getEligibleBlock(t,prevForm,prevForm.blocks.length),i=e.blockResps.chain().find({blockId:v.id}).find({formRespId:c.id}).data();i=i.length>1?i.slice(-1)[0]:1===i.length?i[0]:{id:"new-"+v.id},a+=prevForm.type?prevForm.type:"form",(prevForm.options.forEach||prevForm.options.forEachAnswer)&&(a+="-foreach",d="intro"),n={fsSlug:e.formstack.slug,fsRespId:e.current.fsResp.id,formRespId:c.id,formId:prevForm.id,blockRespId:i.id,hash:d,page:d}}e.newStateParams=n,o.go(a,n)},_getAnswer=function(e,o,t,n){t=t||e.current.fsResp.id,answers=$vpApi.db.getCollection("answer");var r=$vpApi.db.getCollection("answer").chain().find({questionSlug:o}).find({fsRespId:t});n&&(r=r.find({blockRespId:n}));var s=r.data();return s.length>1?(VERBOSE&&console.log("found more than one answer, returns the first one."),console.table(s),s=s[0]):s=1===s.length?s[0]:null,VERBOSE&&console.log("Found answer: "+s),s},getEligibleBlock=function(direction,form,currentBlockIndex){function findEligibleBlock(direction){return VERBOSE&&console.log("[findEligibleNextBlock] looking for blockIndex "+currentBlockIndex),block="forward"===direction?blocks[currentBlockIndex+1]:blocks[currentBlockIndex-1],block?"undefined"!=typeof block.options.skipWhen&&(rs=eval(block.options.skipWhen),rs?(VERBOSE&&console.log("[_getNextBlock()] I need to skip this block and get the next one"),"forward"===direction?currentBlockIndex++:currentBlockIndex--,findEligibleBlock(direction)):VERBOSE&&console.log("[_getNextBlock()] I can use this block.")):VERBOSE&&console.log("[_getNextBlock] there are no more blocks on this form"),block}var out,block,rs,blocks=form.blocks;return block=findEligibleBlock(direction)},loadFormForEachItems=function(e){var o;_.each(e.current.form.forEach,function(o){o.formResp=e.formResps.chain().find({fsRespId:e.current.fsResp.id}).find({formId:e.current.form.id}).find({formForEachItem:o.value}).data(),0===o.formResp.length?(VERBOSE&&console.log("Create a formResp for "+o),o.formResp=e.formResps.insert({fsSlug:e.formstack.slug,fsRespId:e.current.fsResp.id,formId:e.current.form.id,formIndex:e.current.formIndex,formForEachItem:o.value,formForEachQuestionSlug:e.current.form.options.forEachAnswer,client_created:$vpApi.getTimestamp(),client_updated:$vpApi.getTimestamp()}),$vpApi.db.save()):o.formResp=o.formResp[0],o.blockResps=e.blockResps.chain().find({fsRespId:e.current.fsResp.id}).find({formRespId:o.formResp.id}).simplesort("created").data(),o.blockResps.length>0?(o.formRespId=o.blockResps[0].formRespId,o.blockRespId=o.blockResps[0].id,o.isNew=!1):(o.formRespId="new-"+e.current.form.id,o.blockRespId="new-"+e.current.form.blocks[0].id,o.isNew=!0),o.form="form"});var t=e.formResps.chain().find({formId:e.current.form.id}).find({fsRespId:e.current.fsResp.id});_.each(e.current.form.forEach,function(e){t.find({formForEachItem:{$ne:e.value}})}),o=t.data(),VERBOSE&&console.log("Stale Form Resps"),console.table(o),_.each(o,function(e){$formResp.delete(e.id)})},getEligibleForm=function(direction,currentFormIndex,fsSlug){function findEligibleForm(direction){return VERBOSE&&console.log("[findNextEligibleForm] looking for formIndex "+currentFormIndex),form="forward"===direction?forms[currentFormIndex+1]:forms[currentFormIndex-1],form?"undefined"!=typeof form.options.skipWhen&&(rs=eval(form.options.skipWhen),rs?(VERBOSE&&console.log("[_findNextEligibleForm()] I need to skip this form and get the next one"),"forward"===direction?currentFormIndex++:currentFormIndex--,findEligibleForm(direction)):VERBOSE&&console.log("[_findNextEligibleForm()] I can use this form.")):VERBOSE&&console.log("[_getNextBlock] there are no more forms on this form"),form}var forms=$vpApi.getFormstack(fsSlug).forms;return form=findEligibleForm(direction)},loadAnswers=function(e,o,t,n){var r=!1;t+="",n+="",("new"===o||"new"===t.split("-")[0]||"new"===n.split("-")[0])&&(r=!0),e.previousAnswers=r?[]:e.answers.chain().find({fsRespId:o}).find({formRespId:t}).find({blockRespId:n}).data(),_.each(e.current.block.questions,function(o){var t=_.find(e.previousAnswers,function(e){return e.questionId===o.id});t?(o.value=t.value,o.previousValue=t.value,o.answerId=t.id):"undefined"!=typeof o.options["default"]?(o.value=o.options["default"],o.previousValue=o.options["default"],o.answerId=null):(o.value="",o.previousValue="",o.answerId=null)})},parseHash=function(e){var o;if("intro"===e||"end"===e)return e;var t=e.split("/");return 3===t.length?(formRespId=t[0],blockRespId=t[1],qIndex=parseInt(t[2]),o=[formRespId,blockRespId,qIndex]):o=e,o},{setState:setState,changeState:changeState,getAnswer:_getAnswer,getEligibleForm:getEligibleForm,getEligibleBlock:getEligibleBlock,loadAnswers:loadAnswers,parseHash:parseHash}}]),angular.module("vpApi.services",[]).service("$vpApi",["$rootScope","$http","$q","config",function(e,o,t,n){var r=this,s=n.apiBaseUri;this.username="",this.user={},this.users,this.dbLoaded=!1,this.dbinit=function(e){console.log("$vpApi.dbinit]"),r.db=window.data.db,0===r.db.collections.length&&console.error("[$vpApi.dbinit()] There are no collection in the database. Try removing ng-app from you index.html."),r.user=data.user,r.users=data.db.getCollection("user"),r.dbLoaded=!0;var o=r.db.getCollection("fsResp");o.setChangesApi(!0),o.on("insert",function(e){e.id||(e.id=r.generateUUID())}),o=r.db.getCollection("formResp"),o.setChangesApi(!0),o.on("insert",function(e){e.id||(e.id=r.generateUUID())}),o=r.db.getCollection("blockResp"),o.setChangesApi(!0),o.on("insert",function(e){e.id||(e.id=r.generateUUID())}),o=r.db.getCollection("answer"),o.setChangesApi(!0),o.on("insert",function(e){e.id||(e.id=r.generateUUID())}),r.db.save(),"function"==typeof e&&e()},this.generateUUID=function(){var e=(new Date).getTime(),o="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(o){var t=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==o?t:3&t|8).toString(16)});return o},this.getApp=function(e){var o=r.db.getCollection("app"),t=null;return t=void 0==e||null==e?o.find()[0]:o.find({slug:e})[0]},this.getFormstack=function(e){var o=null,t=r.db.getCollection("formstack");return o=void 0==e||null==e?t.find()[0]:t.find({slug:e})[0],o||console.warn("[$vpApi.getFormstack()] Could not find formstack"),o},this.getTimestamp=function(){return(new Date).toISOString()},this.serialize=function(e){var o=[];for(var t in e)e.hasOwnProperty(t)&&o.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return o.join("&")},this.authenticate=function(t,n,c){var i=s+"authenticate/",a={};o.post(i,t,a).success(function(o){var t=r.users.find({username:o.username});0===t.length?user=r.users.insert({username:o.username,token:o.token}):(user=t[0],user.token=o.token,user.username=o.username,r.users.update(user)),r.user=user,r.db.save(),localStorage.setItem("user",JSON.stringify(r.user)),e.$broadcast("authenticated",{onSuccess:n,onError:c})}).error(function(e,o){c(e,o)})},this.fetch=function(e,t,n,r){var c=s+e+"/",i=this.serialize(t);c+="?"+i;var a={headers:{Authorization:"Token "+this.user.token}};o.get(c,a).success(function(e,o){n(e,o)}).error(function(e,o){console.log("get fail"),r(e,o)})},this.ping=function(){var t=s+"pforms/ping/",n={headers:{Authorization:"Token "+this.user.token}};o.get(t,n).success(function(){console.log("ping success"),e.$broadcast("sync-network",{msg:"Connected to "+n.apiBaseUri})}).error(function(){console.log("ping fail"),e.$broadcast("sync-no-network",{msg:"Cannot connected to "+n.apiBaseUri})})},this.post=function(e,t,n,r){{var c=s+e+"/";({headers:{Authorization:"Token "+this.user.token}})}o({url:c,method:"POST",data:t,headers:{Authorization:"Token "+this.user.token,"Content-Type":"application/json; charset=utf-8"}}).success(function(e,o){n(e,o)}).error(function(e,o){r(e,o)})},this.put=function(e,t,n,r){{var c=s+e+"/";({headers:{Authorization:"Token "+this.user.token}})}o({url:c,method:"PUT",data:t,headers:{Authorization:"Token "+this.user.token,"Content-Type":"application/json; charset=utf-8"}}).success(function(e,o){n(e,o)}).error(function(e,o){r(e,o)})},this.patch=function(e,t,n,r){{var c=s+e+"/";({headers:{Authorization:"Token "+this.user.token}})}o({url:c,method:"PATCH",data:t,headers:{Authorization:"Token "+this.user.token,"Content-Type":"application/json; charset=utf-8"}}).success(function(e,o){n(e,o)}).error(function(e,o){r(e,o)})},this.delete=function(e,t,n){var r=s+e+"/";o({url:r,method:"DELETE",headers:{Authorization:"Token "+this.user.token,"Content-Type":"application/json; charset=utf-8"}}).success(function(e,o){t(e,o)}).error(function(e,o){n(e,o)})},this.passwordChange=function(e){var o=t.defer(),n="account/password/change";return r.post(n,e,function(e){o.resolve(e[0],status)},function(e){o.reject(e,status)}),o.promise},this.showCollection=function(e){console.log("SHOW TABLE: "+e),console.table(data.db.getCollection(e).data)},window.data&&(console.log("[$vpApi] About to call dbinit()"),this.dbinit())}]).service("$user",["$rootScope","$vpApi","$app","$formstack","$profile","config",function(e,o,t,n,r,s){var c=this;this.authenticatedCallback=function(n,c){r.fetch(function(){console.log("Got profile"),o.db.save();var n,r=o.user.profile.allowed_apps;if(!(r.length>0))return console.warn("There are no allowed Apps for this user."),void c.onSuccess({},2);if(s.acceptedAppType){var i=_.find(r,function(e){return e.appType===s.acceptedAppType});if(!i)return void c.onSuccess({},2);n=i.appSlug}else n=r[0].appSlug;t.fetchBySlug(n,function(t){console.log("Got app ",t),formstacks=t.formstacks,o.db.getCollection("formstack").clear(),_.each(formstacks,function(e){e.appId=t.id,e.appSlug=t.slug,o.db.getCollection("formstack").insert(e),item={status:"success",attempts:1,lastAttempt:o.getTimestamp(),method:"GET",resourceUri:"/api/v2/pforms/formstack/"+e.id,resourceId:e.id},o.db.getCollection("statusTable").insert(item)}),o.db.save(),e.$broadcast("apploaded"),c.onSuccess({},1)},function(e){console.log("[$user] failed to fetch formstack"),console.log(e),c.onSuccess({},3)})},function(){console.log("Error fetching profile.")})},e.$on("authenticated",function(e,o){c.authenticatedCallback(e,o)})}]).service("$org",["$vpApi","$q",function(e,o){this.update=function(t){var n=o.defer(),r="account/org/"+e.user.profile.orgs[0].id;return e.patch(r,t,function(o,t){e.user.profile.orgs[0]=o,e.db.save(),n.resolve(o,t)},function(e,o){n.reject(e,o)}),n.promise}}]).service("$profile",["$http","$vpApi","$q","config",function(e,o,t,n){var r=n.apiBaseUri;this.fetch=function(t,n){var s=r+"account/info/?user__username=",c=o.user.token,i={headers:{Authorization:"Token "+c}};e.get(s+o.user.username,i).success(function(e){0===e.length&&console.error("[$profile.fetch() User profile not found.]"),o.user.profile=e[0],o.users.update(o.user),t()}).error(function(){n()})},this.update=function(e){var n=t.defer(),r="account/profile/"+o.user.profile.id;return o.patch(r,e,function(e,t){o.user.profile=e,o.db.save(),n.resolve(e,t)},function(e,o){n.reject(e,o)}),n.promise}}]).service("$app",["$vpApi","$rootScope","$q",function(e,o,t){var n=this;this.resource_name="pforms/get/app",this._fetchSuccess=function(o){n.objects=o;var t=e.db.getCollection("app"),r=t.find({slug:o[0].slug});r.length>0&&t.remove(r),t.insert(o[0])},this._fetchFail=function(e,o){console.log("Failed to fetch "+n.resource_name+". Returned Status: "+o),console.log(e)},this.fetchBySlug=function(o,t,r){HAS_CONNECTION?e.fetch(this.resource_name,{slug:o},function(r,s){n.objects=r;var c=e.db.getCollection("app"),i=c.find({slug:o});i.length>0&&c.remove(i),c.insert(r[0]),t(r[0],s)},function(e,o){r(e,o)}):console.warn("[$app.fetchBySlug()] No network connection.")},this.fetchBySlug2=function(o){var r=t.defer();return HAS_CONNECTION?e.fetch(this.resource_name,{slug:o},function(t,s){n.objects=t;var c=e.db.getCollection("app"),i=c.find({slug:o});i.length>0&&c.remove(i),c.insert(t[0]),r.resolve(t[0],s)},function(e,o){r.reject(e,o)}):r.reject({},"Network not found"),r.promise},this.updateBySlug=function(o,t,r,s){var c=n.resource_name,i={slug:o};t&&(i.modified_gte=t,c="pforms/app"),e.fetch(c,i,function(e,t){app=null,1===e.length&&(app=e[0]),r(app,t,o)},function(e,t){n._fetchFail(e,t,o),s(e,t)})}}]).service("$formstack",["$vpApi","$rootScope",function(e,o){var t=this;this.resource_name="pforms/formstack",this.formRepeatItem,this._fetchSuccess=function(o){t.objects=o;var n=e.db.getCollection("formstack"),r=n.find({slug:o[0].slug});r.length>0&&n.remove(r),n.insert(o[0])},this._fetchFail=function(e,o){console.log("Failed to fetch "+t.resource_name+". Returned Status: "+o),console.log(e)},this.fetchBySlug=function(n,r,s){HAS_CONNECTION?e.fetch(this.resource_name,{slug:n},function(s,c){t.objects=s;var i=e.db.getCollection("formstack"),a=i.find({slug:n});a.length>0&&i.remove(a),i.insert(s[0]),o.$broadcast("formstack-updated",n),r(s[0],c)},function(e,o){console.log("Failed to fetch "+t.resource_name+". Returned Status: "+o),console.log(e),s(e,o)}):console.warn("[$vpApi-services.fetchBySlug()] No network connection.")},this.updateBySlug=function(n,r,s,c){var i={slug:n};r&&(i.modified_gte=r),e.fetch(this.resource_name,i,function(e,r){var c=null;e.length>0&&(t._fetchSuccess(e,r,n),c=e[0],o.$broadcast("formstack-updated",n)),s(c,r,n)},function(e,o){t._fetchFail(e,o,n),c(e,o,n)})},this.getQuestionBySlug=function(o,t){var n,r=e.db.getCollection("formstack").find({slug:o})[0];return _.find(r.forms,function(e){return blockRes=_.find(e.blocks,function(e){return qRes=_.find(e.questions,function(e){return e.slug===t?(n=e,!0):void 0})})}),n},this.getChoice=function(e,o,n){var r,s=t.getQuestionBySlug(e,o);return r=_.find(s.choices,function(e){return e.value===n}),r||(r={verbose:"User Enter: "+n,value:n}),r},this.getSlugs=function(){var o=[];return formstacks=e.db.getCollection("formstack").data,o=_.map(formstacks,function(e){return e.slug})}}]).service("$fsResp",["$vpApi","$rootScope","$q",function(e,o,t){var n=this;o.$on("db_loaded",function(){this.objects=e.db.getCollection("fsResp")
}),this.clear=function(){var o=e.db.getCollection("fsResp"),t=e.db.getCollection("formResp"),n=e.db.getCollection("blockResp"),r=e.db.getCollection("answer");o.clear(),t.clear(),n.clear(),r.clear(),e.db.save()},this.delete=function(t,n){e.db.getCollection("fsResp").removeWhere({id:t}),e.db.getCollection("formResp").removeWhere({fsRespId:t}),e.db.getCollection("blockResp").removeWhere({fsRespId:t}),e.db.getCollection("answer").removeWhere({fsRespId:t}),e.db.save(function(){"function"==typeof n&&n()}),console.log("[$fsResp.delete()] Deleted all responses. About to broadcast fsResp-deleted for "+t),o.$broadcast("fsResp-deleted",{fsRespId:t})},this.fetchByFormstackSlug=function(o){var r=t.defer();return e.fetch("pforms/formstack-response",{formstack__slug:o},function(e,o){e.results.length>0&&n.loadResponses(e.results),r.resolve(e.results,o)},function(e,o){r.reject(e.results,o)}),r.promise},this.fetchByRespId=function(o){var r=t.defer();return e.fetch("pforms/formstack-response/"+o,{},function(e,o){n.loadResponses([e]),r.resolve(e,o)},function(e,o){r.reject(e,o)}),r.promise},this.loadResponses=function(o){console.log("[loadResponses]"),_.each(o,function(o){var t=angular.copy(o.formResps);o.formResps=void 0,e.db.getCollection("fsResp").insert(o),_.each(t,function(t){blockResps=angular.copy(t.blockResps),t.blockResps=void 0,t.fsSlug=o.slug,e.db.getCollection("formResp").insert(t),_.each(blockResps,function(n){answers=angular.copy(n.answers),n.answers=void 0,n.fsSlug=o.slug,n.formId=t.formId,e.db.getCollection("blockResp").insert(n),_.each(answers,function(r){r.formId=t.formId,r.blockId=n.blockId,r.fsSlug=o.slug,e.db.getCollection("answer").insert(r)})})})})},this.getFullResp=function(o){var t,n,r;out={};var s=e.db.getCollection("fsResp").find({id:o})[0],c=e.db.getCollection("lastSavedUrl").data[0],i={};return c&&(i={path:c.path,timestamp:c.timestamp}),fsResp=angular.copy(s),fsResp.meta=void 0,fsResp.fsSlug=void 0,fsResp.$loki=void 0,fsResp.options={lastSavedUrl:i},fsResp.formResps=[],n=angular.copy(e.db.getCollection("formResp").find({fsRespId:o})),_.each(n,function(n){t=angular.copy(e.db.getCollection("blockResp").chain().find({fsRespId:o}).find({formRespId:n.id}).data()),_.each(t,function(t){r=angular.copy(e.db.getCollection("answer").chain().find({fsRespId:o}).find({formRespId:n.id}).find({blockRespId:t.id}).data()),_.each(r,function(e){void 0===e.value&&(e.value=null)}),t.answers=r}),n.blockResps=t,fsResp.formResps.push(n)}),fsResp}}]).service("$formResp",["$vpApi",function(e){this.resource_name="pforms/form-response",this.delete=function(o,t){e.db.getCollection("formResp").removeWhere({id:o}),e.db.getCollection("blockResp").removeWhere({formRespId:o}),e.db.getCollection("answer").removeWhere({formRespId:o}),e.db.save(function(){"function"==typeof t&&t()})}}]).service("$blockResp",["$vpApi","$sync","$rootScope",function(e,o,t){var n=this;this.resource_name="pforms/block-response",this.delete=function(o,t){e.db.getCollection("blockResp").removeWhere({id:o}),e.db.getCollection("answer").removeWhere({blockRespId:o}),e.db.save(function(){"function"==typeof t&&t()})},n.reset=function(e){_.each(e,function(e){e.value="",void 0===e.form&&(e.form={}),e.form.show=!0,e.answerId=null,e.options&&e.options.widget&&"web"===platform&&(e.options.widget=e.options.widget.replace("hybrid/","web/"))})},n.load=function(o,t,n,r){var s,c=!1,i=e.db.getCollection("answer");return t+="",n+="",("new"===o||"new"===t.split("-")[0]||"new"===n.split("-")[0])&&(c=!0),s=c?[]:i.chain().find({fsRespId:o}).find({formRespId:t}).find({blockRespId:n}).data(),console.table(s),_.each(r,function(e){var o=_.find(s,function(o){return o.questionId===e.id});o?(e.value=o.value,e.previousValue=o.value,e.answerId=o.id):"undefined"!=typeof e.options["default"]?(e.value=e.options["default"],e.previousValue=e.options["default"],e.answerId=null):(e.value="",e.previousValue="",e.answerId=null)}),r},n.save=function(r,s,c,i,a,l){if(!n.isValid(i))return void t.$broadcast("block-invalid");a=a||"submitted";var f,u=e.db.getCollection("fsResp"),d=e.db.getCollection("formResp"),p=e.db.getCollection("blockResp"),m=e.db.getCollection("answer"),g=formResp=blockResp=formId=formIndex=blockId=blockIndex=null;2===r.split("new-").length?(fsId=parseInt(r.split("new-")[1],10),r="new",f=e.db.getCollection("formstack").find({id:fsId})[0]):(g=u.find({id:r})[0],f=e.db.getCollection("formstack").find({id:g.fsId})[0]),2===s.split("new-").length?(formId=parseInt(s.split("new-")[1],10),s="new",formIndex=_.findIndex(f.forms,function(e){return e.id===formId})):(formResp=d.find({id:s})[0],formIndex=_.findIndex(f.forms,function(e){return e.id===formResp.formId})),2===c.split("new-").length?(blockId=parseInt(c.split("new-")[1],10),c="new",blockIndex=_.findIndex(f.forms[formIndex].blocks,function(e){return e.id===blockId})):blockResp=p.find({id:c})[0];var h=!0;return h?("new"===r?g=u.insert({id:e.generateUUID(),fsId:f.id,fsSlug:f.slug,client_updated:e.getTimestamp(),client_created:e.getTimestamp(),status:a}):(g.client_updated=e.getTimestamp(),u.update(g)),"new"==s?formResp=d.insert({id:e.generateUUID(),fsSlug:f.slug,fsRespId:g.id,formId:formId,formIndex:formIndex,formForEachItem:l||null,client_updated:e.getTimestamp(),client_created:e.getTimestamp()}):(formResp.client_updated=e.getTimestamp(),d.update(formResp)),"new"===c?blockResp=p.insert({id:e.generateUUID(),fsSlug:f.slug,fsRespId:g.id,formId:formId,formIndex:formIndex,formRespId:formResp.id,formForEachItem:l||null,blockId:blockId,blockIndex:blockIndex,client_updated:e.getTimestamp(),client_created:e.getTimestamp()}):(blockResp.client_updated=e.getTimestamp(),p.update(blockResp)),_.each(i,function(o){if(o.answerId){var t=m.find({id:o.answerId})[0];t.value=o.value,t.client_updated=e.getTimestamp(),m.update(t)}else m.insert({id:e.generateUUID(),value:o.value,questionId:o.id,questionSlug:o.slug,blockRespId:blockResp.id,blockId:blockId,formRespId:formResp.id,formId:formId,formForEachItem:l||null,fsRespId:g.id,fsSlug:f.slug,client_updated:e.getTimestamp(),client_created:e.getTimestamp()})}),e.db.save(),"web"===platform&&o.run(function(){}),console.log("******* Block successfully save *********"),t.$broadcast("block-saved",blockResp),g):void 0},n.isValid=function(e){var o=!0;return _.each(e,function(e){console.log("question",e),e.form.clean_answer();var t=e.form.validate_answer();t||(o=!1)}),o}}]).service("$answers",["$form","$rootScope","$filter","$vpApi","config",function(e,o,t,n){this.resource_name="pforms/answer",this.delete=function(e,o){n.db.getCollection("answer").removeWhere({id:e}),n.db.save(function(){"function"==typeof o&&o()})}}]).service("$masterList",["$rootScope","$vpApi","$q",function(e,o,t){var n=this;n.current={resourceName:"",table:[],item:{}},n.new={},n.fetchTable=function(r){var s=t.defer();n[r]=[];var c={};return o.fetch("lookup/"+r,c,function(o,t){n[r]=o,e.$broadcast("lookup-table-loaded",r),s.resolve(o,t)},function(e,o){console.log("[fetchTable] failed",e),s.reject(e,o)}),s.promise}}]),angular.module("vpApi.services").service("$sync",["$rootScope","$http","config","$vpApi","$app","$formstack","$fsResp","$timeout",function(e,o,t,n,r,s,c,i){var a=window.VERBOSE||!1,l=this;this.toasDuration=3e3,this.intervalHandle=null,this.collections=["fsResp","formResp","blockResp","answer"],this.lastUpdate=localStorage.getItem("lastUpdate"),this.statusTable=n.db.getCollection("statusTable"),this.lastUpdate&&(this.lastUpdate=new Date(this.lastUpdate)),this.run=function(o){l.checkConnection(),i(function(){e.$broadcast("sync-start");var t;return window.HAS_CONNECTION!==!0?(console.warn("[sync.run()] No network found, sync cancelled."),void e.$broadcast("sync-no-network")):n.user?(onSucess=function(t,r){e.$broadcast("sync-success",t),o(t,r),n.db.clearChanges(),e.$broadcast("sync-complete")},onError=function(o){a===!0&&console.log("[$sync.run.OnError] ",o.fail),e.$broadcast("sync-fail",o.fail),e.$broadcast("sync-complete")},t=l.getFsResps(),t.length>0&&l.pushFsResps(t,onSucess,onError),l.clearSyncedFormstacks(),void l.updateReadOnly()):(console.warn("[sync.run()] No user found, sync cancelled."),void e.$broadcast("sync-fail",{errors:["No user found, sync cancelled."]}))},1e3)},this.checkConnection=function(){n.ping()},this.getFsResps=function(){var e=n.db.generateChangesNotification(["fsResp"]),o=[];a===!0&&console.log("[sync.run()] Changes: "+_.map(e,function(e){a===!0&&console.log(e)})),e.length>0&&(o=_.map(e,function(e){if(a===!0&&console.log("change.obj.id: "),a===!0&&console.log(e.obj.id),!e.obj.id)return null;var o=n.db.getCollection("fsResp").chain().find({id:e.obj.id}).find({status:{$ne:"rejected"}}).data();return a===!0&&console.log(o),o.length>0?angular.copy(o[0]):void 0})),o=_.compact(o);var t=_.uniq(o,function(e){return e.id});o=_.compact(t),console.log("First query resps",o),a===!0&&console.log("[sync.run()] found "+o.length+" fsResps that changed");var r=n.db.getCollection("statusTable").chain().find({collection:"fsResp"}).find({status:"pending"}).data(),s=[];return r.length>0&&(s=_.map(r,function(e){var o=n.db.getCollection("fsResp").chain().find({id:e.resourceId}).find({status:{$ne:"rejected"}});return o.length>1&&console.warn("[sync.getFsResps] Found more than one fsResp"),o[0]})),a===!0&&console.log("[sync.run()] found "+s.length+" 'pending' fsResps"),s=_.compact(s),console.log("Stale resps",s),o=o.concat(angular.copy(s))},this.pushFsResps=function(o,t,r){a===!0&&console.log("[sync.pushFsResps()] Attempting to sync resp, count: "+o.length);var s,i,l,f,u=0,d=0,p=0,m={success:[],fail:[]},g=n.db.getCollection("statusTable"),h=n.db.getCollection("fsResp");submitSuccess=function(e){f=g.find({resourceId:e.id})[0],f.status="success",i=n.db.getCollection("fsResp").find({id:e.id})[0],i.status=e.status,i.syncedAt=n.getTimestamp(),n.db.save();var t=e.id+" - "+e.fsSlug+" Formstack response successully synced.";m.success.push(t),u++,d++,u===o.length&&(a===!0&&console.log("[sync.pushFsResps()] "+d+" successully sumbitted, "+p+" failed."),finishedSubmitting())},submitFail=function(t,r){var s;a===!0&&console.log("I failed "+r),e.$broadcast("sync-failed",{data:t,status:r}),"rejected"===t.status?(s=h.find({id:t.id})[0],s.status="rejected",s.errors=t.errors,h.update(s),s=g.find({resourceId:t.id})[0],s.status="success",g.update(s)):(s=g.find({resourceId:t.id})[0],s.status="fail",g.update(s)),n.db.save();var c=(t.id+" - "+t.fsSlug+" Formstack response successully synced.",{fsRespId:t.id,errors:t.errors});m.fail.push(c),u++,p++,u===o.length&&finishedSubmitting()},finishedSubmitting=function(){0===m.fail.length?t(m,"Finished submitting formstacks."):r(m,"Finished submitting formstacks with errors.")},_.each(o,function(e){s=c.getFullResp(e.id),l="pforms/formstack/"+s.fsId+"/submit";var o=n.db.getCollection("statusTable"),t=o.find({resourceId:e.id});0===t.length?(t={status:"pending",attempts:1,lastAttempt:n.getTimestamp(),method:"POST",resourceUri:l,collection:"fsResp",resourceId:e.id},o.insert(t)):(t.status="pending",t.attempts++,t.lastAttempt=n.getTimestamp(),o.update(t)),n.db.save(),n.post(l,s,submitSuccess,submitFail)})},this.clearSyncedFormstacks=function(){var e,o,r,s=new Date,i=n.db.getCollection("fsResp").chain().find({status:"synced"}).where(function(n){return o=new Date(n.syncedAt),e=(s-o)/1e3,a===!0&&console.log(e),e>t.ARCHIVE_DT}).data();_.each(i,function(e){r=l.statusTable.find({resourceId:e.id})[0],l.statusTable.remove(r),c.delete(e.id)})},this.updateReadOnly=function(){a===!0&&console.log("[sync.updateReadOnly()] "),appObj=l._updateApp();var o=e.$on("app-updated",function(e,t){var n,r,c=s.getSlugs();r=t.app.formstacks.length>0&&t.app.formstacks[0].slug?_.map(t.app.formstacks,function(e){return e.slug}):t.app.localFormstacks;{var i=_.difference(r,c);_.difference(c,r)}n=c.concat(i),l._updateFormstacks(n),o()})},this._updateApp=function(){var o,t=n.getApp(),s=l.statusTable.find({resourceId:t.id});s.length>0?(s.length>1&&console.warn("[sync._updateApp] More than 1 entry found in statusTable for app "+t.slug+". Using the first one."),o=s[0],o=s[0],last_ts=s[0].lastAttempt,o.entrys++,o.status="pending",o.lastAttempt=n.getTimestamp(),l.statusTable.update(o)):(last_ts=new Date(2015,1,1).toISOString(),o={status:"pending",entrys:1,lastAttempt:n.getTimestamp(),method:"GET",resourceUri:"/api/v2/pforms/app/"+t.id,resourceId:t.id,collection:"app"},l.statusTable.insert(o)),n.db.save(),success=function(o){t=n.getApp(),null===o||a===!0&&console.log("[sync._updateApp] app updated: "+t.slug);var r=l.statusTable.find({resourceId:t.id})[0];r.status="success",l.statusTable.update(r),n.db.save(),e.$broadcast("app-updated",{app:t})},error=function(e,o){console.warn("sync.[_updateApp] update failed, status "+o),a===!0&&console.log(e)},r.updateBySlug(t.slug,last_ts,success,error)},this._updateFormstacks=function(e){_.each(e,function(e){var o,t=n.db.getCollection("formstack").find({slug:e})[0];success=function(e,o,r){t=n.db.getCollection("formstack").find({slug:r})[0],null===e?a===!0&&console.log("[sync._updateFormstacks] No updates found for "+r):a===!0&&console.log("[sync._updateFormstacks] formstack updated: "+t.slug);var s=l.statusTable.find({resourceId:t.id}),c={};1===s.length?(c=s[0],c.status="success",l.statusTable.update(c)):s.length>0?console.warn("[sync._updateFormstacks()] Found more than 1 attempt record in the statusTable."):0===s.length&&console.warn("[sync._updateFormstacks()] Could not find previous attempt."),n.db.save()},error=function(e,o){console.warn("[sync._updateFormstacks] update failed, status "+o),a===!0&&console.log(e)},a===!0&&console.log("[sync._updateFormstacks] Checking for updates to formstack "+t.slug);var r=l.statusTable.find({resourceId:t.id});1===r.length?(o=r[0],last_ts=r[0].lastAttempt,o.attempts++,o.status="pending",o.lastAttempt=n.getTimestamp(),l.statusTable.update(o)):0===r.length?(last_ts=new Date(2015,1,1).toISOString(),o={status:"pending",attempts:1,lastAttempt:n.getTimestamp(),method:"GET",resourceUri:"/api/v2/pforms/formstack/"+t.id,resourceId:t.id},l.statusTable.insert(o)):console.warn("[sync._updateFormstacks] More than one previous attempt found before checking for updates."),n.db.save(),s.updateBySlug(t.slug,last_ts,success,error)})},saveListenerHandler=function(){l.saveListener();var o=function(){a===!0&&console.log("[db.save] Success")},t=function(){a===!0&&console.log("[db.save] Fail")},r=angular.copy(n.db.getCollection("fsResp").data);l.pushFsResps(r,o,t),i(function(){a===!0&&console.log("restarting db.save listener"),l.saveListener=e.$on("db.save",saveListenerHandler)},1e3)},l.saveListener=e.$on("db.save",saveListenerHandler)}]);