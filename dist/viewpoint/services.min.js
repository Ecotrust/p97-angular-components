angular.module("vpApi.services",[]).service("$vpApi",["$rootScope","$http","config",function(e,o,t){var n=this,s=t.apiBaseUri;this.username="",this.user={},this.users,this.dbLoaded=!1,this.dbinit=function(e){return n.db=data.db,n.user=data.user,n.users=data.db.getCollection("user"),void(n.dbLoaded=!0)},this.getFormstack=function(){var e=null;try{e=n.db.getCollection("formstack").find({slug:n.user.profile.allowed_formstacks[0]})[0]}catch(o){console.log("[$vpApi.getFormstack()] Could not find formstack"),console.log(o)}return e},this.getTimestamp=function(){return(new Date).toISOString()},this.serialize=function(e){var o=[];for(var t in e)e.hasOwnProperty(t)&&o.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return o.join("&")},this.authenticate=function(t,c,r){console.log("[$vpApi.authenticate]");var i=s+"authenticate/",a={};o.post(i,t,a).success(function(o){var s=n.users.find({username:t.username});0===s.length?user=n.users.insert({username:t.username,token:o.token}):(user=s[0],user.token=o.token,user.username=t.username,n.users.update(user)),n.user=user,n.db.save(),localStorage.setItem("user",JSON.stringify(n.user)),console.log("broadcasting authenticated"),e.$broadcast("authenticated",{onSuccess:c})}).error(function(e,o){r(e,o)})},this.fetch=function(e,t,n,c){var r=s+e+"/",i=this.serialize(t);r+="?"+i;var a={headers:{Authorization:"Token "+this.user.token}};o.get(r,a).success(function(e,o){n(e,o)}).error(function(e,o){c(e,o)})},this.post=function(e,t,n,c){{var r=s+e+"/";({headers:{Authorization:"Token "+this.user.token}})}o({url:r,method:"POST",data:t,headers:{Authorization:"Token "+this.user.token}}).success(function(e,o){n(e,o)}).error(function(e,o){c(e,o)})},this.dbinit()}]).service("$user",["$rootScope","$vpApi","$formstack","$profile",function(e,o,t,n){e.$on("authenticated",function(e,s){n.fetch(function(){console.log("[$user] got profile"),o.db.save();try{var e=o.user.profile.allowed_formstacks[0]}catch(n){console.log("No allowed formstacks found.")}t.fetchBySlug(e,function(){console.log("[$user] succesfully fetched formstack"),o.db.save(),s.onSuccess()},function(e){console.log("[$user] failed to fetch formstack"),console.log(e)})},function(){console.log("Error fetching profile.")})})}]).service("$profile",["$http","$vpApi","config",function(e,o,t){var n=t.apiBaseUri;this.fetch=function(t,s){var c=n+"account/info/?user__username=",r=o.user.token,i={headers:{Authorization:"Token "+r}};console.log("[$profile.fetch()] About to fetch profile"),e.get(c+o.user.username,i).success(function(e){console.log("[$profile.fetch() callback] got data"),o.user.profile=e[0],o.users.update(o.user),t()}).error(function(){s()})}}]).service("$formstack",["$vpApi",function(e){var o=this;this.resource_name="pforms/formstack",this.formRepeatItem,this._fetchSuccess=function(t){o.objects=t,console.log("[$formstack.fetchSuccess] got data, now updating formstack collection");var n=e.db.getCollection("formstack"),s=n.find({slug:t[0].slug});s.length>0&&n.remove(s),n.insert(t[0])},this._fetchFail=function(e,t){console.log("Failed to fetch "+o.resource_name+". Returned Status: "+t),console.log(e)},this.fetchBySlug=function(t,n,s){HAS_CONNECTION&&(console.log("[$formstack.fetchBySlug] About to fetch formstack."),e.fetch(this.resource_name,{slug:t},function(s,c){o.objects=s,console.log("[$formstack.fetchBySlug] got data");var r=e.db.getCollection("formstack"),i=r.find({slug:t});i.length>0&&r.remove(i),r.insert(s[0]),n(s[0],c)},function(e,t){console.log("Failed to fetch "+o.resource_name+". Returned Status: "+t),console.log(e),s(e,t)}))},this.updateBySlug=function(t,n,s){console.log("[$formstack.fetchBySlug] About to fetch formstack.");var c={slug:t};e.fetch(this.resource_name,c,function(e,t){o._fetchSuccess(e,t),n(e[0])},function(e,t){o._fetchFail(e,t),s(e,t)})}}]).service("$fsResp",["$vpApi","$rootScope",function(e,o){var t=this;this.resource_name="pforms/formstack-response",o.$on("db_loaded",function(){console.log("$fsResp received db_loaded"),this.objects=e.db.getCollection("fsResp")}),this.delete=function(o){var n=t.objects.get(o);t.objects.remove(n);var s=e.db.getCollection("formResp").find({fsRespId:o}),c=e.db.getCollection("blockResp").find({fsRespId:o}),r=e.db.getCollection("answer").find({fsRespId:o});console.log("Deleting "+s.length+" form responses"),_.each(s,function(o){e.db.getCollection("formResp").remove(o)}),console.log("Deleting "+c.length+" block responses"),_.each(c,function(o){e.db.getCollection("blockResp").remove(o)}),console.log("Deleting "+r.length+" answers"),_.each(r,function(o){e.db.getCollection("answer").remove(o)}),e.db.save()}}]).service("$formResp",["$vpApi",function(){this.resource_name="pforms/form-response"}]).service("$blockResponse",["$formstack","$block","$rootScope","$answers","$formResponse",function(e,o,t){this.resource_name="pforms/block-response",t.$on("answer-created",function(){})}]).service("$answers",["$form","$rootScope","$filter","$vpApi","config",function(){this.resource_name="pforms/answer"}]).service("$mediacache",["$vpApi","$formstack","$http",function(e,o,t){var n=this;n.isCached=!1,this.run=function(){var o=n.getFilenames();_.each(o,function(o){t({method:"GET",withCredentials:!0,url:o}).success(function(t){var n=e.db.getCollection("media"),s=n.find({fname:o});s.length>0?(s.cupdate=e.getTimestamp(),n.update(s)):(s={fname:o,data:t,cupdate:e.getTimestamp()},n.insert(s)),e.db.save()}).error(function(){console.log("Could not load media file ")})})},this.getFilenames=function(){var o=e.getFormstack(),t=[];return _.each(o.forms,function(e){_.each(e.blocks,function(e){_.each(e.questions,function(e){e.options.geojsonChoices&&e.options.geojsonChoices.url&&(console.log("[getFilenames] found media file "+e.options.geojsonChoices.url),t.push(e.options.geojsonChoices.url))})})}),console.log("[getFilenames] File to cache: "),console.log(t),t}}]).service("$tilecache",["$vpApi","$formstack",function(e){var o=this;this.regions=[],this.isCached=function(){var e=localStorage.getItem("tilesCached"),o="true"===e?!0:!1;return o},this.getMaxCacheZoom=function(){var o=e.getFormstack(),t=_.find(o.forms,function(e){return"map-form"===e.options.type});return t?t.options.maxCacheZoom:null},this.getRegions=function(){console.log("[$tilecache.getRegions()] WTF"),out=[];var t=e.getFormstack();return _.each(t.forms,function(e){"map-form"===e.type&&e.options.regions&&(out=_.uniq(out.concat(e.options.regions))),console.log("[$tilecache.getRegions()] Found "+out.length+" regions")}),o.regions=out,out},this.getTileSources=function(){console.log("[$tilecache.getTileSources()] WTF"),out=[];var t=e.getFormstack();return _.each(t.forms,function(e){"map-form"===e.type&&e.options.tileSources&&(out=_.uniq(out.concat(e.options.tileSources))),console.log("[$tilecache.getTileSources()] Found "+out.length+" regions")}),o.tileSources=out,out},this.loadRegions=function(e,t){if(0===o.regions.length)return o.getRegions(),void(0===o.regions.length);var n=o.getMaxCacheZoom(),s=o.offlineLayer.calculateNbTiles(n,o.regions);1e4>s?(console.log("Will be saving: "+s+" tiles"),o.offlineLayer.saveRegions(o.regions,n,function(){console.log("[saveRegions] onStarted")},function(){console.log("[saveRegions] onSuccess"),localStorage.setItem("tilesCached","true"),e()},function(e){console.log("onError"),console.log(e),t()})):alert("You are trying to save "+s+" tiles. There is currently a limit of 10,000 tiles.")},this.run=function(e,t){console.log("[$tilecache.run()]");var n=o.getTileSources()[0];onError=function(e,o,n){console.log("[$tilecache.run.onError()] "),localStorage.setItem("tilesCached","false"),console.log(e),console.log(o),console.log(n),t()};var s=L.map("cache-map").setView([-2.9,-79],13),c={map:s,maxZoom:12,attribution:n.attrib,dbOnly:!0,onReady:function(){console.log("onReady for what?")},onError:function(){console.log("onError for what?")},storeName:n.storeName,dbOption:"WebSQL"};o.offlineLayer=new OfflineLayer(n.url,c),o.loadRegions(e,t)},clearTiles=function(){console.log("clearing tiles..."),o.offlineLayer.clearTiles(function(){console.log("[clearTiles] success")},function(){console.log("[clearTiles] fail")})}}]);