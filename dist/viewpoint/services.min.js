angular.module("vpApi.services",[]).service("$vpApi",["$rootScope","$http","config",function(e,o,t){var s=this,n=t.apiBaseUri;this.username="",this.user={},this.users,this.dbLoaded=!1,this.dbinit=function(e){return s.db=data.db,s.user=data.user,s.users=data.db.getCollection("user"),void(s.dbLoaded=!0)},this._createDb=function(){s.db.addCollection("user"),s.db.addCollection("formstack"),s.db.addCollection("fsResp"),s.db.addCollection("formResp"),s.db.addCollection("blockResp"),s.db.addCollection("answer"),console.log("[$vpApi._createDb] Created tables. About to save to local storage."),s.db.save(),console.log("[$vpApi._createDb] Saved db to local storage.")},this.getFormstack=function(){var e=null;try{e=s.db.getCollection("formstack").find({slug:s.user.profile.allowed_formstacks[0]})[0]}catch(o){console.log("[$vpApi.getFormstack()] Could not find formstack"),console.log(o)}return e},this.getTimestamp=function(){return(new Date).toISOString()},this.authenticate=function(t,c,r){console.log("[$vpApi.authenticate]");var i=n+"authenticate/",l={};o.post(i,t,l).success(function(o){var n=s.users.find({username:t.username});0===n.length?user=s.users.insert({username:t.username,token:o.token}):(user=n[0],user.token=o.token,user.username=t.username,s.users.update(user)),s.user=user,s.db.save(),localStorage.setItem("user",JSON.stringify(s.user)),console.log("broadcasting authenticated"),e.$broadcast("authenticated",{onSuccess:c})}).error(function(e,o){r(e,o)})},this.fetch=function(e,t,s,c){var r=n+e+"/",i={headers:{Authorization:"Token "+this.user.token}};o.get(r,i).success(function(e,o){s(e,o)}).error(function(e,o){c(e,o)})},this.post=function(e,t,s,c){{var r=n+e+"/";({headers:{Authorization:"Token "+this.user.token}})}o({url:r,method:"POST",data:t,headers:{Authorization:"Token "+this.user.token}}).success(function(e,o){s(e,o)}).error(function(e,o){c(e,o)})},this.dbinit()}]).service("$user",["$rootScope","$vpApi","$formstack","$profile",function(e,o,t,s){e.$on("authenticated",function(e,n){s.fetch(function(){console.log("[$user] got profile"),o.db.save();try{var e=o.user.profile.allowed_formstacks[0]}catch(s){console.log("No allowed formstacks found.")}t.fetchBySlug(e,function(){console.log("[$user] succesfully fetched formstack"),o.db.save(),n.onSuccess()},function(e){console.log("[$user] failed to fetch formstack"),console.log(e)})},function(){console.log("Error fetching profile.")})})}]).service("$profile",["$http","$vpApi","config",function(e,o,t){var s=t.apiBaseUri;this.fetch=function(t,n){var c=s+"account/info/?user__username=",r=o.user.token,i={headers:{Authorization:"Token "+r}};console.log("[$profile.fetch()] About to fetch profile"),e.get(c+o.user.username,i).success(function(e){console.log("[$profile.fetch() callback] got data"),o.user.profile=e[0],o.users.update(o.user),t()}).error(function(){n()})}}]).service("$formstack",["$vpApi",function(e){var o=this;this.resource_name="pforms/formstack",this.formRepeatItem,this._fetchSuccess=function(t){o.objects=t,console.log("[$formstack.fetchSuccess] got data, now updating formstack collection");var s=e.db.getCollection("formstack"),n=s.find({slug:t[0].slug});n.length>0&&s.remove(n),s.insert(t[0])},this._fetchFail=function(e,t){console.log("Failed to fetch "+o.resource_name+". Returned Status: "+t),console.log(e)},this.fetchBySlug=function(t,s,n){HAS_CONNECTION&&(console.log("[$formstack.fetchBySlug] About to fetch formstack."),e.fetch(this.resource_name,{slug:t},function(n,c){o.objects=n,console.log("[$formstack.fetchBySlug] got data");var r=e.db.getCollection("formstack"),i=r.find({slug:t});i.length>0&&r.remove(i),r.insert(n[0]),s(n[0],c)},function(e,t){console.log("Failed to fetch "+o.resource_name+". Returned Status: "+t),console.log(e),n(e,t)}))},this.updateBySlug=function(t,s,n){console.log("[$formstack.fetchBySlug] About to fetch formstack.");var c={slug:t};e.fetch(this.resource_name,c,function(e,t){o._fetchSuccess(e,t),s(e[0])},function(e,t){o._fetchFail(e,t),n(e,t)})}}]).service("$fsResp",["$vpApi","$rootScope",function(e,o){var t=this;this.resource_name="pforms/formstack-response",o.$on("db_loaded",function(){console.log("$fsResp received db_loaded"),this.objects=e.db.getCollection("fsResp")}),this.delete=function(o){var s=t.objects.get(o);t.objects.remove(s);var n=e.db.getCollection("formResp").find({fsRespId:o}),c=e.db.getCollection("blockResp").find({fsRespId:o}),r=e.db.getCollection("answer").find({fsRespId:o});console.log("Deleting "+n.length+" form responses"),_.each(n,function(o){e.db.getCollection("formResp").remove(o)}),console.log("Deleting "+c.length+" block responses"),_.each(c,function(o){e.db.getCollection("blockResp").remove(o)}),console.log("Deleting "+r.length+" answers"),_.each(r,function(o){e.db.getCollection("answer").remove(o)}),e.db.save()}}]).service("$formResp",["$vpApi",function(){this.resource_name="pforms/form-response"}]).service("$blockResponse",["$formstack","$block","$rootScope","$answers","$formResponse",function(e,o,t){this.resource_name="pforms/block-response",t.$on("answer-created",function(){})}]).service("$answers",["$form","$rootScope","$filter","$vpApi","config",function(){this.resource_name="pforms/answer"}]).service("$tilecache",["$vpApi","$formstack",function(e){var o=this;this.regions=[],this.isCached=function(){var e=localStorage.getItem("tilesCached"),o="true"===e?!0:!1;return o},this.getMaxCacheZoom=function(){var o=e.getFormstack(),t=_.find(o.forms,function(e){return"map-form"===e.options.type});return t?t.options.maxCacheZoom:null},this.getRegions=function(){console.log("[$tilecache.getRegions()] WTF"),out=[];var t=e.getFormstack();return _.each(t.forms,function(e){"map-form"===e.type&&e.options.regions&&(out=_.uniq(out.concat(e.options.regions))),console.log("[$tilecache.getRegions()] Found "+out.length+" regions")}),o.regions=out,out},this.getTileSources=function(){console.log("[$tilecache.getTileSources()] WTF"),out=[];var t=e.getFormstack();return _.each(t.forms,function(e){"map-form"===e.type&&e.options.tileSources&&(out=_.uniq(out.concat(e.options.tileSources))),console.log("[$tilecache.getTileSources()] Found "+out.length+" regions")}),o.tileSources=out,out},this.loadRegions=function(e,t){if(0===o.regions.length)return o.getRegions(),void(0===o.regions.length);var s=o.getMaxCacheZoom(),n=o.offlineLayer.calculateNbTiles(s,o.regions);1e4>n?(console.log("Will be saving: "+n+" tiles"),o.offlineLayer.saveRegions(o.regions,s,function(){console.log("[saveRegions] onStarted")},function(){console.log("[saveRegions] onSuccess"),localStorage.setItem("tilesCached","true"),e()},function(e){console.log("onError"),console.log(e),t()})):alert("You are trying to save "+n+" tiles. There is currently a limit of 10,000 tiles.")},this.run=function(e,t){console.log("[$tilecache.run()]");var s=o.getTileSources()[0];onError=function(e,o,s){console.log("[$tilecache.run.onError()] "),localStorage.setItem("tilesCached","false"),console.log(e),console.log(o),console.log(s),t()};var n=L.map("cache-map").setView([-2.9,-79],13),c={map:n,maxZoom:12,attribution:s.attrib,dbOnly:!0,onReady:function(){console.log("onReady for what?")},onError:function(){console.log("onError for what?")},storeName:s.storeName,dbOption:"WebSQL"};o.offlineLayer=new OfflineLayer(s.url,c),o.loadRegions(e,t)},clearTiles=function(){console.log("clearing tiles..."),o.offlineLayer.clearTiles(function(){console.log("[clearTiles] success")},function(){console.log("[clearTiles] fail")})}}]);